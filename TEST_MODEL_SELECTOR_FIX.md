# 模型选择器修复 - 快速测试指南

## 🎯 测试目标

验证应用生成页面的模型选择器是否能正常切换模型。

---

## ⚡ 快速测试（5分钟）

### 步骤 1: 启动应用

```bash
# 后端
mvnw.cmd spring-boot:run

# 前端（新窗口）
cd ai-code-mother-frontend
npm run dev
```

### 步骤 2: 创建测试应用

1. 打开 `http://localhost:5173`
2. 在主页输入框输入：`创建一个简单的计数器`
3. 点击左侧 **+** 按钮，选择模型：**codex-mini-latest**
4. 点击 **发送** 创建应用

### 步骤 3: 测试模型切换 ⭐

1. 进入刚创建的应用生成页面
2. **观察左侧聊天区的AI头像**（应该显示 codex/openai 图标）
3. **打开浏览器开发者工具**（F12）
4. 切换到 **Network（网络）** 标签
5. 在左下角找到模型选择器（显示当前模型）
6. 点击模型选择器，切换到 **qwen3-max**
7. **观察AI头像是否变成了 qwen 图标** ⭐ 关键检查点
8. 在输入框输入：`把计数器按钮改成红色`
9. 发送消息

### 步骤 4: 验证结果

**验证点 1: AI头像图标** ⭐ 新增
```
左侧聊天区的AI头像：
✅ 切换前: OpenAI 图标（蓝色）
✅ 切换后: Qwen 图标（紫色）
```

**验证点 2: Network 请求**
在 Network 标签中找到最新的请求：
```
GET /api/app/chat/gen/code?appId=...&message=...&modelKey=qwen3-max
                                                         ↑
                                              ✅ 应该是 qwen3-max
```

**如果两个验证点都通过，说明修复完全成功！** 🎉

---

## 🧪 详细测试用例

### 测试用例 1: 初始模型显示

**预期结果**: 页面加载时，模型选择器显示应用创建时使用的模型

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 主页创建应用，选择 `codex-mini-latest` | 应用创建成功 |
| 2 | 进入应用生成页面 | ✅ 左下角显示 `codex-mini-latest` 图标 |
| 3 | 点击模型选择器 | ✅ 当前选中 `codex-mini-latest` |

---

### 测试用例 2: 模型切换生效

**预期结果**: 选择新模型后，图标和请求都更新

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击模型选择器，选择 `qwen3-max` | ✅ 选择器图标变为 qwen |
| 2 | 观察左侧聊天区的AI头像 | ✅ **AI头像也变为 qwen 图标** ⭐ |
| 3 | 发送消息：`修改按钮颜色` | ✅ 消息发送成功 |
| 4 | 查看 Network 请求 | ✅ `modelKey=qwen3-max` |
| 5 | 查看新消息的AI头像 | ✅ **新消息显示 qwen 图标** ⭐ |
| 6 | 查看 AI 响应 | ✅ 使用 qwen3-max 生成代码 |

---

### 测试用例 3: 多次切换模型

**预期结果**: 每次切换都立即生效，图标实时变化

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 选择 `codex-mini-latest` | ✅ AI头像变为 OpenAI 图标 |
| 2 | 发送消息 | ✅ 使用 `codex-mini-latest` |
| 3 | 选择 `qwen3-max` | ✅ AI头像变为 Qwen 图标 |
| 4 | 发送消息 | ✅ 使用 `qwen3-max` |
| 5 | 选择 `deepseek-r1` | ✅ AI头像变为 DeepSeek 图标 |
| 6 | 发送消息 | ✅ 使用 `deepseek-r1` |

---

### 测试用例 4: 页面刷新保持

**预期结果**: 刷新页面后，显示应用原本的模型

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 应用原本使用 `codex-mini-latest` | - |
| 2 | 切换到 `qwen3-max` 并发送消息 | ✅ 使用 `qwen3-max` |
| 3 | 刷新页面（F5） | ✅ 模型选择器恢复为 `codex-mini-latest` |
| 4 | 再次切换到 `qwen3-max` | ✅ 可以切换 |

---

## 🔍 问题排查

### 问题 1: 模型选择器图标不更新

**可能原因**: 缓存问题

**解决方法**:
```bash
# 清除浏览器缓存
Ctrl + Shift + Delete

# 或强制刷新
Ctrl + F5
```

---

### 问题 2: Network 中 modelKey 仍是旧值

**可能原因**: 代码未生效

**解决方法**:
```bash
# 重启前端开发服务器
cd ai-code-mother-frontend
npm run dev
```

---

### 问题 3: 模型选择器打不开

**可能原因**: API 未返回模型列表

**解决方法**:
```bash
# 检查后端是否运行
curl http://localhost:8123/api/health

# 检查模型列表 API
curl http://localhost:8123/api/ai-model-config/list/enabled
```

---

## 📊 测试报告模板

### ✅ 测试通过

```
测试环境: Windows 10 / Chrome 120
测试时间: 2025-01-XX 14:30
测试人员: 张三

测试结果:
✅ 测试用例 1: 初始模型显示 - 通过
✅ 测试用例 2: 模型切换生效 - 通过
✅ 测试用例 3: 多次切换模型 - 通过
✅ 测试用例 4: 页面刷新保持 - 通过

总结: 所有测试用例通过，修复有效！
```

### ❌ 测试失败

```
测试环境: Windows 10 / Chrome 120
测试时间: 2025-01-XX 14:30
测试人员: 张三

测试结果:
✅ 测试用例 1: 初始模型显示 - 通过
❌ 测试用例 2: 模型切换生效 - 失败
   错误: modelKey 仍为 codex-mini-latest
   截图: screenshot.png

需要进一步调试...
```

---

## 🎓 调试技巧

### 1. 控制台日志

打开浏览器控制台（F12 → Console），应该看到：

```javascript
// 切换模型时
切换模型: qwen3-max {modelKey: "qwen3-max", modelName: "Qwen3 Max", ...}

// 发送消息前
[发送消息] 用户输入: 修改按钮颜色
[发送消息] 使用模型: qwen3-max  ← 检查这里！
```

### 2. Vue DevTools

安装 Vue DevTools 扩展，可以实时查看：
- `selectedModelKey` 的值
- `appInfo.modelKey` 的值
- `showModelSelector` 的状态

### 3. Network 请求分析

找到 `/app/chat/gen/code` 请求，查看：
- **Request URL**: 应包含 `modelKey=新选择的模型`
- **Query String Parameters**: 
  ```
  appId: 123456789
  message: 修改按钮颜色
  runId: run_xxx
  modelKey: qwen3-max  ← 关键参数
  ```

---

## 📞 反馈渠道

如果测试过程中遇到问题：

1. 截图保存错误信息
2. 复制 Console 中的错误日志
3. 记录复现步骤
4. 提交 Issue 或反馈给开发团队

---

## ✨ 预期效果

修复后，应用生成页面的模型选择器应该：

- ✅ 能够显示当前使用的模型
- ✅ 能够打开模型列表
- ✅ 能够切换到新模型
- ✅ 切换后立即生效
- ✅ **AI头像图标会实时变化** ⭐ 新增
- ✅ 每次发送消息都使用当前选择的模型
- ✅ 新消息的AI头像显示正确的模型图标 ⭐ 新增
- ✅ 刷新页面不影响功能

---

**测试难度**: ⭐⭐☆☆☆ (简单)  
**预计时间**: 5-10 分钟  
**重要程度**: ⭐⭐⭐⭐⭐ (关键功能)
