<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SSEæµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button.clear {
            background: #f44336;
        }
        button.clear:hover {
            background: #da190b;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ”§ SSEæ¥å£æµ‹è¯•å·¥å…·</h1>

    <div class="controls">
        <button onclick="testSSE()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
        <button class="clear" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <pre id="log"></pre>

    <script>
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logEl.innerHTML += `<span class="${className}">[${time}] ${msg}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testSSE() {
            clearLog();

            // ä½¿ç”¨æœ€æ–°åˆ›å»ºçš„åº”ç”¨ID
            const appId = 334411905117859840;
            const message = "ç”Ÿæˆä¸€ä¸ªç®€å•çš„çº¢è‰²æŒ‰é’®";
            const modelKey = "gpt-5-low";

            const url = `http://localhost:8123/api/app/chat/gen/code?appId=${appId}&message=${encodeURIComponent(message)}&modelKey=${modelKey}`;

            log('ğŸ¬ å¼€å§‹æµ‹è¯•SSEæ¥å£...', 'info');
            log(`ğŸ“ URL: ${url}`, 'info');
            log(`ğŸ†” åº”ç”¨ID: ${appId}`, 'info');
            log(`ğŸ’¬ æç¤ºè¯: ${message}`, 'info');
            log(`ğŸ¤– æ¨¡å‹: ${modelKey}`, 'info');
            log('â”'.repeat(80), 'info');

            const eventSource = new EventSource(url);
            let dataCount = 0;
            let totalChars = 0;
            const startTime = Date.now();

            eventSource.onopen = () => {
                log('âœ… SSEè¿æ¥å·²å»ºç«‹', 'success');
            };

            eventSource.onmessage = (event) => {
                dataCount++;
                try {
                    const data = JSON.parse(event.data);
                    const content = data.d || '';
                    totalChars += content.length;

                    if (content) {
                        const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                        log(`ğŸ“¨ [æ¶ˆæ¯ #${dataCount}] æ”¶åˆ° ${content.length} å­—ç¬¦: ${preview}`, 'info');
                    } else {
                        log(`ğŸ“­ [æ¶ˆæ¯ #${dataCount}] æ”¶åˆ°ç©ºæ•°æ®ï¼ˆkeepaliveï¼‰`, 'info');
                    }
                } catch (e) {
                    log(`âš ï¸ [æ¶ˆæ¯ #${dataCount}] æ— æ³•è§£ææ•°æ®: ${event.data.substring(0, 100)}`, 'error');
                }
            };

            eventSource.addEventListener('done', (event) => {
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                log('â”'.repeat(80), 'info');
                log('âœ… ç”Ÿæˆå®Œæˆï¼', 'success');
                log(`ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:`, 'info');
                log(`   - æ€»æ¶ˆæ¯æ•°: ${dataCount}`, 'info');
                log(`   - æ€»å­—ç¬¦æ•°: ${totalChars}`, 'info');
                log(`   - è€—æ—¶: ${duration}ç§’`, 'info');
                eventSource.close();
            });

            eventSource.addEventListener('interrupted', (event) => {
                log('âš ï¸ ç”Ÿæˆè¢«ä¸­æ–­', 'error');
                eventSource.close();
            });

            eventSource.onerror = (error) => {
                log(`âŒ è¿æ¥é”™è¯¯!`, 'error');
                log(`   ReadyState: ${eventSource.readyState}`, 'error');
                log(`   (0=CONNECTING, 1=OPEN, 2=CLOSED)`, 'error');

                if (eventSource.readyState === 2) {
                    log('ğŸ’¡ å¯èƒ½çš„åŸå› :', 'info');
                    log('   1. æœªç™»å½• - è¯·å…ˆåœ¨ä¸»åº”ç”¨ä¸­ç™»å½•', 'info');
                    log('   2. ç½‘ç»œé”™è¯¯ - æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ', 'info');
                    log('   3. æƒé™é—®é¢˜ - æ£€æŸ¥åº”ç”¨æ˜¯å¦å±äºå½“å‰ç”¨æˆ·', 'info');
                }

                eventSource.close();
            };

            // 60ç§’è¶…æ—¶
            setTimeout(() => {
                if (eventSource.readyState !== EventSource.CLOSED) {
                    log('â±ï¸ æµ‹è¯•è¶…æ—¶(60ç§’)ï¼Œå…³é—­è¿æ¥', 'error');
                    eventSource.close();
                }
            }, 60000);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        window.onload = () => {
            log('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨SSEæµ‹è¯•å·¥å…·!', 'success');
            log('ğŸ’¡ ä½¿ç”¨è¯´æ˜:', 'info');
            log('   1. ç¡®ä¿å·²åœ¨ä¸»åº”ç”¨(http://localhost:5173)ä¸­ç™»å½•', 'info');
            log('   2. ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®', 'info');
            log('   3. æŸ¥çœ‹SSEæ•°æ®æµè¾“å‡º', 'info');
            log('â”'.repeat(80), 'info');
        };
    </script>
</body>
</html>
