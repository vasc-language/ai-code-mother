# AppChatPage é‡æ„ç‰ˆæœ¬å¯¹æ¯”åˆ†æ

## ğŸ“ æ–‡ä»¶å¯¹æ¯”æ¦‚è§ˆ

| æ–‡ä»¶ | çŠ¶æ€ | å®Œæ•´åº¦ | ä¸»è¦é—®é¢˜ |
|------|------|--------|---------|
| **AppChatPage.backup.vue** | âœ… åŸå§‹å·¥ä½œç‰ˆæœ¬ | 100% | ä»£ç é‡å¤§ï¼ˆçº¦1400è¡Œï¼‰ï¼Œéš¾ç»´æŠ¤ |
| **AppChatPage.lovable.vue** | âš ï¸ UIé‡æ„ç‰ˆæœ¬ | 30% | åŠŸèƒ½å…¨æ˜¯å ä½ç¬¦ï¼Œæ— å®é™…é€»è¾‘ |
| **AppChatPage.refactored.vue** | âš ï¸ æ—©æœŸé‡æ„å°è¯• | 40% | æœ‰TODOæ ‡è®°ï¼Œæ ¸å¿ƒåŠŸèƒ½æœªå®ç° |
| **AppChatPage.vue** | âœ… å½“å‰ä½¿ç”¨ç‰ˆæœ¬ | 90% | å·²ä¿®å¤SSEé—®é¢˜ï¼ŒåŸºæœ¬å¯ç”¨ |

---

## ğŸ” è¯¦ç»†åŠŸèƒ½å¯¹æ¯”

### 1. ä»£ç ç”ŸæˆåŠŸèƒ½

#### âœ… AppChatPage.backup.vue (åŸå§‹ç‰ˆæœ¬)
```typescript
// ä½¿ç”¨åŸç”Ÿ EventSource
const generateCode = async (userMessage: string, aiMessageIndex: number) => {
  // âœ… å®Œæ•´çš„SSEæ‰¹å¤„ç†æœºåˆ¶
  const flushToUi = () => { /* æ‰¹é‡åˆ·æ–°UI */ }

  // âœ… EventSource é…ç½®
  const newEventSource = new EventSource(url, {
    withCredentials: true,  // Cookieè®¤è¯
  })

  // âœ… ç›‘å¬å¤šç§äº‹ä»¶
  newEventSource.onopen = function () { /* ... */ }
  newEventSource.onmessage = function (event) { /* æ‰¹é‡æ”¶é›† */ }
  newEventSource.addEventListener('done', function () { /* å®Œæˆå¤„ç† */ })
  newEventSource.addEventListener('interrupted', function () { /* åœæ­¢å¤„ç† */ })
  newEventSource.addEventListener('business-error', function () { /* é”™è¯¯å¤„ç† */ })

  // âœ… æ€§èƒ½ç›‘æ§
  sseMetrics = {
    runId, codeGenType, totalBytes, flushCount, /* ... */
  }

  // âœ… ä¸åŒç±»å‹å†…å®¹è¿‡æ»¤
  if (codeGenType === CodeGenTypeEnum.HTML) {
    textForLeft = filterHtmlContent(fullContent)
  } else if (codeGenType === CodeGenTypeEnum.MULTI_FILE) {
    textForLeft = filterOutCodeBlocks(fullContent)
  } else if (codeGenType === CodeGenTypeEnum.VUE_PROJECT) {
    textForLeft = formatVueProjectContent(fullContent)
  }
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ‰¹é‡UIåˆ·æ–°ï¼ˆ40mså®šæ—¶å™¨ï¼‰- å‡å°‘UIæŠ–åŠ¨
- âœ… runId è¿½è¸ªæœºåˆ¶ - é˜²æ­¢æ—§è¯·æ±‚å¹²æ‰°
- âœ… æ€§èƒ½æŒ‡æ ‡è®°å½• - TTFTã€ååé‡
- âœ… å®Œæ•´çš„äº‹ä»¶ç›‘å¬ - done/interrupted/business-error
- âœ… ä¸åŒç”Ÿæˆç±»å‹çš„å†…å®¹è¿‡æ»¤

---

#### âš ï¸ AppChatPage.lovable.vue (å ä½ç¬¦ç‰ˆæœ¬)
```typescript
const onPrimaryActionClick = () => {
  if (isGenerating.value) {
    isGenerating.value = false
    message.info('å·²åœæ­¢ç”Ÿæˆ')  // âŒ åªæ˜¯æ”¹çŠ¶æ€ï¼Œæ²¡æœ‰å®é™…åœæ­¢
  } else {
    if (userInput.value.trim()) {
      message.success('æ¶ˆæ¯å·²å‘é€')  // âŒ åªæ˜¯æç¤ºï¼Œæ²¡æœ‰å®é™…å‘é€
      userInput.value = ''
    }
  }
}
```

**ç¼ºå¤±åŠŸèƒ½**ï¼š
- âŒ æ²¡æœ‰ SSE è¿æ¥
- âŒ æ²¡æœ‰è°ƒç”¨ useCodeGeneration
- âŒ æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯ message.info/success å ä½ç¬¦
- âŒ æ²¡æœ‰å®é™…çš„ä»£ç ç”Ÿæˆé€»è¾‘

---

#### âš ï¸ AppChatPage.refactored.vue (TODOç‰ˆæœ¬)
```typescript
const sendMessage = async () => {
  if (!userInput.value.trim() || isGenerating.value) return

  const message = userInput.value.trim()
  userInput.value = ''

  addUserMessage(message)
  const aiMessageIndex = addAiMessagePlaceholder()

  isGenerating.value = true
  // TODO: è°ƒç”¨ä»£ç ç”Ÿæˆé€»è¾‘
  // await generateCode(message, aiMessageIndex)
}
```

**é—®é¢˜**ï¼š
- âš ï¸ ä»£ç ç”Ÿæˆé€»è¾‘æ ‡è®°ä¸º TODOï¼Œæœªå®ç°
- âš ï¸ loadMoreHistory ä¹Ÿæ˜¯ TODO
- âš ï¸ æ²¡æœ‰å®é™…è°ƒç”¨ useCodeGeneration

---

#### âœ… AppChatPage.vue (å½“å‰ç‰ˆæœ¬)
```typescript
const sendMessage = async () => {
  const message = userInput.value.trim()
  if (!message || isGenerating.value) return

  userInput.value = ''
  addUserMessage(message)
  const aiMessageIndex = addAiMessagePlaceholder()

  // âœ… å®é™…è°ƒç”¨ä»£ç ç”Ÿæˆ
  await startCodeGeneration(
    appId.value,
    message,
    appInfo.value?.codeGenType,
    (content: string) => {
      updateAiMessage(aiMessageIndex, content, true)
      scrollToBottom()
    },
    () => {
      updateAiMessage(aiMessageIndex, messages.value[aiMessageIndex].content, false)
      scrollToBottom()
    },
    appInfo.value?.modelKey  // âœ… ä¼ å…¥ modelKey
  )
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä½¿ç”¨ useCodeGeneration composable
- âœ… å·²ä¿®å¤ SSE äº‹ä»¶å¤„ç†é—®é¢˜ï¼ˆdone/interruptedï¼‰
- âœ… ä¼ å…¥ modelKey å‚æ•°
- âœ… å®Œæ•´çš„å›è°ƒæœºåˆ¶ï¼ˆonMessageUpdate, onCompleteï¼‰

---

### 2. èŠå¤©å†å²åŠ è½½

#### âœ… AppChatPage.backup.vue
```typescript
const loadChatHistory = async (isLoadMore = false) => {
  if (!appId.value) return

  try {
    loadingHistory.value = true
    const pageSize = 20
    const currentPage = Math.floor(messages.value.filter(m => m.type === 'user').length / pageSize)

    const res = await ChatControllerService.getChatHistoryUsingGet({
      appId: appId.value,
      page: isLoadMore ? currentPage : 0,
      pageSize,
    })

    // âœ… å¤„ç†å†å²æ¶ˆæ¯
    if (res.data?.records) {
      const historyMessages = res.data.records.reverse().map(record => {
        // è¯¦ç»†çš„æ¶ˆæ¯æ ¼å¼åŒ–é€»è¾‘
      })

      if (isLoadMore) {
        messages.value = [...historyMessages, ...messages.value]
      } else {
        messages.value = historyMessages
      }

      hasMoreHistory.value = res.data.current < res.data.pages
    }
  } catch (error) {
    console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error)
  } finally {
    loadingHistory.value = false
  }
}
```

**åŠŸèƒ½**ï¼š
- âœ… åˆ†é¡µåŠ è½½ï¼ˆ20æ¡/é¡µï¼‰
- âœ… åŠ è½½æ›´å¤šæ”¯æŒ
- âœ… å†å²æ¶ˆæ¯æ ¼å¼åŒ–
- âœ… é”™è¯¯å¤„ç†

---

#### âŒ AppChatPage.lovable.vue & refactored.vue & vue
```typescript
const loadMoreHistory = () => {
  message.info('åŠ è½½æ›´å¤šå†å²')  // âŒ å ä½ç¬¦
}
```

**é—®é¢˜**ï¼šæ‰€æœ‰é‡æ„ç‰ˆæœ¬éƒ½æ²¡æœ‰å®ç°èŠå¤©å†å²åŠ è½½ï¼

---

### 3. å†…å®¹è¿‡æ»¤å‡½æ•°

#### âœ… AppChatPage.backup.vue
```typescript
// HTMLå†…å®¹è¿‡æ»¤
const filterHtmlContent = (content: string): string => {
  // ç§»é™¤ä»£ç å—æ ‡è®°
  // æå–ä»£ç å—å¤–çš„æè¿°æ€§æ–‡æœ¬
  // ç‰¹æ®Šå¤„ç†
}

// å¤šæ–‡ä»¶å†…å®¹è¿‡æ»¤
const filterOutCodeBlocks = (content: string): string => {
  // ç§»é™¤ [MULTI_FILE_*] æ ‡è®°
  // ç§»é™¤ä»£ç å›´æ 
  // ä¿ç•™æè¿°æ–‡æœ¬
}

// Vueé¡¹ç›®å†…å®¹æ ¼å¼åŒ–
const formatVueProjectContent = (content: string): string => {
  // æ ¼å¼åŒ–Vueé¡¹ç›®ç”Ÿæˆå†…å®¹
  // æå–å…³é”®ä¿¡æ¯
}
```

**åŠŸèƒ½**ï¼š
- âœ… æ ¹æ®ä¸åŒç”Ÿæˆç±»å‹è¿‡æ»¤å†…å®¹
- âœ… è®©å·¦ä¾§èŠå¤©é¢æ¿åªæ˜¾ç¤ºæè¿°æ–‡å­—
- âœ… è®©å³ä¾§ä»£ç é¢æ¿æ˜¾ç¤ºå®Œæ•´ä»£ç 

---

#### âŒ æ‰€æœ‰é‡æ„ç‰ˆæœ¬
**é—®é¢˜**ï¼šè¿™äº›è¿‡æ»¤å‡½æ•°åœ¨ useCodeGeneration.ts ä¸­æœ‰éƒ¨åˆ†å®ç°ï¼Œä½†ï¼š
- âš ï¸ `stripDisplayArtifacts` åªç§»é™¤äº†éƒ¨åˆ†æ ‡è®°
- âŒ æ²¡æœ‰é’ˆå¯¹ä¸åŒç±»å‹çš„ä¸“é—¨è¿‡æ»¤é€»è¾‘
- âŒ å¯¼è‡´å·¦ä¾§èŠå¤©é¢æ¿å¯èƒ½æ˜¾ç¤ºä»£ç å—

---

### 4. æµå¼å†…å®¹è§£æ

#### âœ… AppChatPage.backup.vue
```typescript
// è§£ææµå¼å†…å®¹ï¼ˆå®æ—¶å¢é‡è§£æï¼‰
const parseStreamingContent = (newChunk: string, fullContent: string) => {
  if (!fullContent) return

  const codeGenType = appInfo.value?.codeGenType || CodeGenTypeEnum.HTML

  if (codeGenType === CodeGenTypeEnum.HTML) {
    // âœ… æå–HTMLä»£ç å¹¶å®æ—¶æ›´æ–°é¢„è§ˆ
    const htmlCode = extractHtmlFromStream(fullContent)
    if (htmlCode) {
      simpleCodeFile.value = {
        id: 'html-file',
        name: 'index.html',
        content: htmlCode,
        language: 'html',
      }
      createPreviewUrl(htmlCode)
    }
  } else if (codeGenType === CodeGenTypeEnum.MULTI_FILE) {
    // âœ… å¢é‡è§£æå¤šæ–‡ä»¶
    parseMultiFileIncrementally(newChunk, fullContent)
  } else if (codeGenType === CodeGenTypeEnum.VUE_PROJECT) {
    // âœ… å¢é‡è§£æVueé¡¹ç›®
    parseVueProjectIncrementally(newChunk, fullContent)
  }
}
```

**ç‰¹æ€§**ï¼š
- âœ… å¢é‡è§£æ - è¾¹ç”Ÿæˆè¾¹æ˜¾ç¤º
- âœ… å®æ—¶é¢„è§ˆæ›´æ–°
- âœ… å¤šæ–‡ä»¶å¢é‡åˆå¹¶

---

#### âš ï¸ useCodeGeneration.ts (å½“å‰ç‰ˆæœ¬)
```typescript
// åªåœ¨ done äº‹ä»¶æ—¶è§£æä¸€æ¬¡
if (event.event === 'done') {
  parseGeneratedContent(accumulatedContent, codeGenType).then(() => {
    generationFinished.value = true
    onComplete()
  })
  return
}
```

**é—®é¢˜**ï¼š
- âš ï¸ åªåœ¨ç”Ÿæˆå®Œæˆåè§£æä¸€æ¬¡
- âŒ æ²¡æœ‰æµå¼å¢é‡è§£æ
- âŒ ç”Ÿæˆè¿‡ç¨‹ä¸­çœ‹ä¸åˆ°å³ä¾§ä»£ç æ›´æ–°

---

### 5. éƒ¨ç½²å’Œä¸‹è½½åŠŸèƒ½

#### âœ… AppChatPage.backup.vue
```typescript
// ä¸‹è½½ä»£ç 
const downloadCode = async () => {
  if (!appId.value || !isOwner.value) return

  try {
    downloading.value = true
    const res = await AppControllerService.downloadCodeUsingGet({
      appId: appId.value,
    })

    if (res.data) {
      // âœ… çœŸå®ä¸‹è½½æ–‡ä»¶
      const blob = new Blob([res.data])
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `${appInfo.value?.appName || 'code'}.zip`
      a.click()
      window.URL.revokeObjectURL(url)
      message.success('ä¸‹è½½æˆåŠŸ')
    }
  } catch (error) {
    console.error('ä¸‹è½½å¤±è´¥:', error)
    message.error('ä¸‹è½½å¤±è´¥')
  } finally {
    downloading.value = false
  }
}

// éƒ¨ç½²åº”ç”¨
const deployApp = async () => {
  if (!appId.value) return

  try {
    deploying.value = true
    const res = await AppControllerService.deployAppUsingPost({
      appId: appId.value,
    })

    if (res.data) {
      deployUrl.value = res.data
      deployModalVisible.value = true
      await fetchAppInfo()  // âœ… åˆ·æ–°åº”ç”¨ä¿¡æ¯
    }
  } catch (error) {
    console.error('éƒ¨ç½²å¤±è´¥:', error)
    message.error('éƒ¨ç½²å¤±è´¥')
  } finally {
    deploying.value = false
  }
}
```

**åŠŸèƒ½**ï¼š
- âœ… çœŸå®çš„APIè°ƒç”¨
- âœ… æ–‡ä»¶ä¸‹è½½å¤„ç†
- âœ… éƒ¨ç½²URLæ˜¾ç¤º
- âœ… é”™è¯¯å¤„ç†

---

#### âš ï¸ useAppDeployment.ts (é‡æ„ç‰ˆæœ¬)
```typescript
const downloadCode = async (appId: any) => {
  if (!appId) return

  try {
    downloading.value = true
    const res = await AppControllerService.downloadCodeUsingGet({ appId })

    if (res.data) {
      // âœ… æœ‰çœŸå®å®ç°
      const blob = new Blob([res.data])
      // ... ä¸‹è½½å¤„ç†
    }
  } catch (error) {
    message.error('ä¸‹è½½å¤±è´¥')
  } finally {
    downloading.value = false
  }
}
```

**çŠ¶æ€**ï¼š
- âœ… useAppDeployment.ts æœ‰å®Œæ•´å®ç°
- âœ… AppChatPage.vue æ­£ç¡®è°ƒç”¨äº† composable
- âš ï¸ AppChatPage.lovable.vue åªæœ‰setTimeoutæ¨¡æ‹Ÿ

---

### 6. å¯è§†åŒ–ç¼–è¾‘å™¨

#### âœ… AppChatPage.backup.vue
```typescript
// å¯ç”¨ç¼–è¾‘æ¨¡å¼
const enableEditMode = () => {
  if (!iframeRef.value?.contentDocument) {
    message.warning('è¯·ç­‰å¾…é¢„è§ˆåŠ è½½å®Œæˆ')
    return
  }

  isEditMode.value = true
  visualEditor.enable(iframeRef.value.contentDocument)
  message.success('ç¼–è¾‘æ¨¡å¼å·²å¯ç”¨ï¼Œç‚¹å‡»å…ƒç´ è¿›è¡Œé€‰æ‹©')
}

// ç¦ç”¨ç¼–è¾‘æ¨¡å¼
const disableEditMode = () => {
  isEditMode.value = false
  visualEditor.disable()
  clearSelectedElement()
}

// ç”Ÿæˆå¸¦å…ƒç´ ä¸Šä¸‹æ–‡çš„è¾“å…¥
const getInputWithElementContext = (): string => {
  if (!selectedElementInfo.value) return userInput.value

  const { tagName, id, className, textContent, attributes } = selectedElementInfo.value

  let contextPrompt = `è¯·ä¿®æ”¹ ${tagName.toLowerCase()} å…ƒç´ `
  if (id) contextPrompt += `ï¼ˆid="${id}"ï¼‰`
  else if (className) contextPrompt += `ï¼ˆclass="${className}"ï¼‰`

  contextPrompt += `:\n\n`
  contextPrompt += `å½“å‰å†…å®¹: ${textContent || '(ç©º)'}\n`
  contextPrompt += `ä¿®æ”¹è¦æ±‚: ${userInput.value}\n`

  return contextPrompt
}
```

**åŠŸèƒ½**ï¼š
- âœ… iframeå…ƒç´ é€‰æ‹©
- âœ… å…ƒç´ ä¿¡æ¯æå–
- âœ… ä¸Šä¸‹æ–‡å¢å¼ºçš„æç¤ºè¯
- âœ… å¯è§†åŒ–åé¦ˆ

---

#### âš ï¸ useVisualEditor.ts (é‡æ„ç‰ˆæœ¬)
```typescript
export function useVisualEditor() {
  // âœ… æœ‰å®Œæ•´çš„å¯è§†åŒ–ç¼–è¾‘å™¨å®ç°
  // âœ… ä½† AppChatPage.vue æ²¡æœ‰å®Œæ•´é›†æˆ
}
```

**é—®é¢˜**ï¼š
- âœ… composable å·²åˆ›å»ºï¼ŒåŠŸèƒ½å®Œæ•´
- âš ï¸ AppChatPage.vue ä¸­æ²¡æœ‰è°ƒç”¨ `getInputWithElementContext`
- âš ï¸ å‘é€æ¶ˆæ¯æ—¶æ²¡æœ‰å¢å¼ºæç¤ºè¯
- âš ï¸ æ²¡æœ‰ enableEditMode/disableEditMode æŒ‰é’®

---

### 7. SSEæ€§èƒ½ç›‘æ§

#### âœ… AppChatPage.backup.vue
```typescript
// æ€§èƒ½æŒ‡æ ‡è®°å½•
sseMetrics = {
  runId: null,
  codeGenType: 'HTML',
  afterStop: false,
  t0: performance.now(),      // å¼€å§‹æ—¶é—´
  t1: null,                   // è¿æ¥æ‰“å¼€æ—¶é—´
  t2: null,                   // é¦–ä¸ªæ¶ˆæ¯åˆ°è¾¾æ—¶é—´
  totalBytes: 0,              // æ€»å­—èŠ‚æ•°
  flushCount: 0,              // åˆ·æ–°æ¬¡æ•°
  firstFlushAt: null,         // é¦–æ¬¡åˆ·æ–°æ—¶é—´
}

// done äº‹ä»¶ä¸­æ‰“å°æŒ‡æ ‡
console.info('[SSE-METRICS][done]', {
  runId: currentRunId.value,
  codeGenType: sseMetrics.codeGenType,
  afterStop: sseMetrics.afterStop,
  ttftOpenMs: Math.round(t1 - t0),        // Time To First Token (è¿æ¥)
  ttftFirstMsgMs: Math.round(t2 - t0),    // Time To First Token (æ¶ˆæ¯)
  totalBytes: sseMetrics.totalBytes,
  flushCount: sseMetrics.flushCount,
  avgBytesPerSec: tps,                    // ååé‡
})
```

**ä¼˜åŠ¿**ï¼š
- âœ… TTFT (Time To First Token) æµ‹é‡
- âœ… ååé‡ç»Ÿè®¡
- âœ… æ€§èƒ½è°ƒä¼˜ä¾æ®

---

#### âŒ æ‰€æœ‰é‡æ„ç‰ˆæœ¬
**é—®é¢˜**ï¼šæ²¡æœ‰æ€§èƒ½ç›‘æ§ï¼Œéš¾ä»¥è°ƒä¼˜

---

## ğŸ“‹ ç¼ºå¤±åŠŸèƒ½æ¸…å•

### AppChatPage.lovable.vue (Lovableé£æ ¼ç‰ˆ)
- âŒ **ä»£ç ç”Ÿæˆ** - åªæœ‰å ä½ç¬¦
- âŒ **èŠå¤©å†å²åŠ è½½** - æœªå®ç°
- âŒ **éƒ¨ç½²/ä¸‹è½½** - åªæœ‰setTimeoutæ¨¡æ‹Ÿ
- âŒ **å¯è§†åŒ–ç¼–è¾‘** - æœªé›†æˆ
- âŒ **å†…å®¹è¿‡æ»¤** - æ— 
- âŒ **æµå¼è§£æ** - æ— 
- âŒ **æ€§èƒ½ç›‘æ§** - æ— 

### AppChatPage.refactored.vue (æ—©æœŸé‡æ„ç‰ˆ)
- âš ï¸ **ä»£ç ç”Ÿæˆ** - æ ‡è®°ä¸ºTODO
- âŒ **èŠå¤©å†å²åŠ è½½** - æ ‡è®°ä¸ºTODO
- âš ï¸ **éƒ¨ç½²/ä¸‹è½½** - æœ‰composableä½†æœªå®Œæ•´æµ‹è¯•
- âŒ **å¯è§†åŒ–ç¼–è¾‘** - æœªé›†æˆ
- âŒ **å†…å®¹è¿‡æ»¤** - æ— 
- âŒ **æµå¼è§£æ** - æ— 
- âŒ **æ€§èƒ½ç›‘æ§** - æ— 

### AppChatPage.vue (å½“å‰ç‰ˆæœ¬)
- âœ… **ä»£ç ç”Ÿæˆ** - å·²ä¿®å¤SSEé—®é¢˜
- âŒ **èŠå¤©å†å²åŠ è½½** - æœªå®ç°ï¼ˆå ä½ç¬¦ï¼‰
- âœ… **éƒ¨ç½²/ä¸‹è½½** - å·²å®ç°
- âš ï¸ **å¯è§†åŒ–ç¼–è¾‘** - composableå­˜åœ¨ä½†æœªå®Œæ•´é›†æˆ
- âš ï¸ **å†…å®¹è¿‡æ»¤** - useCodeGenerationä¸­æœ‰éƒ¨åˆ†å®ç°
- âš ï¸ **æµå¼è§£æ** - åªåœ¨doneäº‹ä»¶æ—¶è§£æï¼Œæ— å¢é‡è§£æ
- âŒ **æ€§èƒ½ç›‘æ§** - æ— 

---

## ğŸ¯ å»ºè®®ä¼˜åŒ–æ–¹å‘

### ä¼˜å…ˆçº§ P0 (å¿…é¡»ä¿®å¤)
1. âœ… **SSEäº‹ä»¶å¤„ç†** - å·²ä¿®å¤ï¼ˆdone/interruptedï¼‰
2. âŒ **èŠå¤©å†å²åŠ è½½** - éœ€è¦ä»backupç‰ˆæœ¬ç§»æ¤
3. âš ï¸ **å¯è§†åŒ–ç¼–è¾‘å™¨é›†æˆ** - éœ€è¦åœ¨å‘é€æ¶ˆæ¯æ—¶è°ƒç”¨ `getInputWithElementContext`

### ä¼˜å…ˆçº§ P1 (é‡è¦ä¼˜åŒ–)
4. âš ï¸ **æµå¼å¢é‡è§£æ** - æ¢å¤ `parseStreamingContent` å‡½æ•°ï¼Œå®ç°è¾¹ç”Ÿæˆè¾¹æ˜¾ç¤º
5. âš ï¸ **å†…å®¹è¿‡æ»¤ä¼˜åŒ–** - æ¢å¤ `filterHtmlContent`, `filterOutCodeBlocks`, `formatVueProjectContent`
6. âŒ **æ‰¹é‡UIåˆ·æ–°** - æ¢å¤ `flushToUi` æœºåˆ¶ï¼ˆ40mså®šæ—¶å™¨ï¼‰

### ä¼˜å…ˆçº§ P2 (æ€§èƒ½ä¼˜åŒ–)
7. âŒ **æ€§èƒ½ç›‘æ§** - æ¢å¤ sseMetrics æŒ‡æ ‡è®°å½•
8. âš ï¸ **runIdè¿½è¸ª** - useCodeGeneration ä¸­å·²æœ‰ï¼Œéœ€ç¡®ä¿å…¨å±€ä¸€è‡´
9. âŒ **business-erroräº‹ä»¶** - å¢åŠ ä¸šåŠ¡é”™è¯¯ç›‘å¬

---

## ğŸ“Š ä»£ç å¤ç”¨å»ºè®®

### ä» backup.vue ç§»æ¤åˆ°å½“å‰ç‰ˆæœ¬

#### 1. èŠå¤©å†å² â†’ useChatMessages.ts
```typescript
// ç§»æ¤ loadChatHistory å‡½æ•°
export function useChatMessages() {
  // ... ç°æœ‰ä»£ç 

  const loadChatHistory = async (isLoadMore = false) => {
    // å¤åˆ¶ backup.vue çš„å®ç°
  }

  return {
    // ... ç°æœ‰è¿”å›
    loadChatHistory,  // æ–°å¢
  }
}
```

#### 2. æµå¼è§£æ â†’ useCodeGeneration.ts
```typescript
export function useCodeGeneration() {
  // ... ç°æœ‰ä»£ç 

  // æ–°å¢ï¼šæµå¼å¢é‡è§£æ
  const parseStreamingContent = (newChunk: string, fullContent: string) => {
    // å¤åˆ¶ backup.vue çš„å®ç°
  }

  // ä¿®æ”¹ï¼šonmessage ä¸­è°ƒç”¨
  onmessage: (event) => {
    // ... ç°æœ‰ä»£ç 

    accumulatedContent += chunk

    // âœ… æ–°å¢ï¼šæµå¼è§£æ
    parseStreamingContent(chunk, accumulatedContent)

    onMessageUpdate(stripDisplayArtifacts(accumulatedContent))
  }
}
```

#### 3. å†…å®¹è¿‡æ»¤ â†’ useCodeGeneration.ts
```typescript
// æ–°å¢è¿‡æ»¤å‡½æ•°
const filterHtmlContent = (content: string): string => { /* ... */ }
const filterOutCodeBlocks = (content: string): string => { /* ... */ }
const formatVueProjectContent = (content: string): string => { /* ... */ }

// åœ¨ onmessage ä¸­ä½¿ç”¨
onMessageUpdate(applyFilter(accumulatedContent, codeGenType))
```

#### 4. å¯è§†åŒ–ç¼–è¾‘ â†’ AppChatPage.vue
```typescript
// å¯¼å…¥ useVisualEditor
import { useVisualEditor } from './composables/useVisualEditor'

const {
  isEditMode,
  selectedElementInfo,
  toggleEditMode,
  getInputWithElementContext,
} = useVisualEditor()

// ä¿®æ”¹ sendMessage
const sendMessage = async () => {
  // âœ… ä½¿ç”¨å¢å¼ºçš„è¾“å…¥
  const message = isEditMode.value
    ? getInputWithElementContext()
    : userInput.value.trim()

  // ... å…¶ä½™ä»£ç 
}
```

---

## âœ… ç»“è®º

### å½“å‰æœ€ä½³å®è·µ

**AppChatPage.vue** æ˜¯ç›®å‰æœ€å¯ç”¨çš„ç‰ˆæœ¬ï¼š
- âœ… SSEäº‹ä»¶å¤„ç†å·²ä¿®å¤
- âœ… åŸºç¡€ä»£ç ç”ŸæˆåŠŸèƒ½æ­£å¸¸
- âœ… éƒ¨ç½²/ä¸‹è½½å·²å®ç°
- âš ï¸ ä½†ä»éœ€è¡¥å……ä¸Šè¿°ç¼ºå¤±åŠŸèƒ½

**å»ºè®®æ–¹æ¡ˆ**ï¼š
1. **ä¸è¦**ä½¿ç”¨ lovable.vue æˆ– refactored.vueï¼ˆåŠŸèƒ½ä¸å®Œæ•´ï¼‰
2. **ç»§ç»­**ä½¿ç”¨å½“å‰çš„ AppChatPage.vue
3. **é€æ­¥**ä» backup.vue ç§»æ¤ç¼ºå¤±åŠŸèƒ½åˆ° composables
4. **ä¿æŒ** composable æ¶æ„ï¼Œä½†è¡¥å…¨åŠŸèƒ½å®ç°

---

## ğŸ“ ç§»æ¤ä¼˜å…ˆçº§

```
ç¬¬ä¸€æ‰¹ï¼ˆæœ¬å‘¨ï¼‰ï¼š
  1. âœ… SSEäº‹ä»¶å¤„ç† - å·²å®Œæˆ
  2. èŠå¤©å†å²åŠ è½½
  3. å¯è§†åŒ–ç¼–è¾‘å™¨é›†æˆ

ç¬¬äºŒæ‰¹ï¼ˆä¸‹å‘¨ï¼‰ï¼š
  4. æµå¼å¢é‡è§£æ
  5. å†…å®¹è¿‡æ»¤ä¼˜åŒ–
  6. æ‰¹é‡UIåˆ·æ–°

ç¬¬ä¸‰æ‰¹ï¼ˆä¼˜åŒ–ï¼‰ï¼š
  7. æ€§èƒ½ç›‘æ§
  8. business-erroräº‹ä»¶
  9. é”™è¯¯æ¢å¤æœºåˆ¶
```

---

**ç”Ÿæˆæ—¶é—´**: 2025-10-10 æ·±å¤œ
**åˆ†æä¾æ®**: AppChatPage.backup.vue (lines 1-1400) vs é‡æ„ç‰ˆæœ¬å¯¹æ¯”
