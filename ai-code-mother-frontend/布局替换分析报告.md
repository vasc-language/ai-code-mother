# AppChatPage å¸ƒå±€æ›¿æ¢åˆ†ææŠ¥å‘Š

## ä¸€ã€æ–°å¸ƒå±€æ ¸å¿ƒç‰¹å¾ï¼ˆæ¥è‡ªæ–°æ–‡ä»¶ 722è¡Œï¼‰

### 1.1 HTML ç»“æ„æ¦‚è§ˆ

```vue
<template>
  <div class="lovable-app-chat-page">
    <!-- Lovable é£æ ¼é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="lovable-header">
      <div class="header-left">
        <router-link to="/" class="logo-link">
          <img src="/favicon.ico" alt="Logo" class="app-logo" />
        </router-link>
        <div class="app-info">
          <h1 class="app-name">åº”ç”¨åç§°</h1>
          <span class="code-gen-badge">ç±»å‹æ ‡ç­¾</span>
        </div>
      </div>
      <div class="header-actions">
        <!-- è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ (é¢„è§ˆ/ä»£ç ) -->
        <div class="view-toggle-group">...</div>
        <!-- åˆ†éš”çº¿ -->
        <div class="header-divider"></div>
        <!-- æ“ä½œæŒ‰é’®ï¼šè¯¦æƒ…ã€å†å²ã€ä¸‹è½½ã€éƒ¨ç½² -->
        <button class="header-btn">...</button>
        <button class="header-btn header-btn-primary">éƒ¨ç½²</button>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº - å·¦å³åˆ†å±å¸ƒå±€ -->
    <main class="lovable-main">
      <!-- å·¦ä¾§ï¼šChatGPT é£æ ¼èŠå¤©é¢æ¿ (40% å®½åº¦) -->
      <div class="left-panel chat-panel-container">
        <ChatPanelLovable />
      </div>

      <!-- ä¸­é—´ï¼šå¯è°ƒèŠ‚åˆ†éš”æ¡ -->
      <div class="resizer" @mousedown="startResize"></div>

      <!-- å³ä¾§ï¼šVS Code é£æ ¼ä»£ç /é¢„è§ˆé¢æ¿ (60% å®½åº¦) -->
      <div class="right-panel code-panel-container">
        <CodePanelLovable />
      </div>
    </main>
  </div>
</template>
```

### 1.2 æ–°å¸ƒå±€å…³é”®ç»„ä»¶

**æ–°å¢çš„ Lovable é£æ ¼ç»„ä»¶ï¼š**
1. `ChatPanelLovable` - èŠå¤©é¢æ¿ç»„ä»¶ (ç¬¬142è¡Œå¯¼å…¥)
2. `CodePanelLovable` - ä»£ç /é¢„è§ˆé¢æ¿ç»„ä»¶ (ç¬¬143è¡Œå¯¼å…¥)

**ç»„ä»¶è·¯å¾„ï¼š**
```javascript
// ç¬¬142-143è¡Œ
import ChatPanelLovable from './components/lovable/ChatPanelLovable.vue'
import CodePanelLovable from './components/lovable/CodePanelLovable.vue'
```

### 1.3 æ–°å¸ƒå±€ CSS æ ¸å¿ƒæ ·å¼è¦ç‚¹

#### é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ (ç¬¬412-570è¡Œ)
```css
.lovable-header {
  height: 64px;
  background: linear-gradient(135deg, #fff5f0 0%, #ffe8dd 100%); /* æ¸å˜æ©™è‰²èƒŒæ™¯ */
  backdrop-filter: blur(20px);
  box-shadow: 0 4px 20px rgba(255, 107, 53, 0.08);
}

.code-gen-badge {
  background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); /* æ©™è‰²æ¸å˜å¾½ç«  */
  border-radius: 30px;
  box-shadow: 0 4px 12px rgba(255, 107, 53, 0.35);
}

.view-toggle-group {
  background: white;
  border-radius: 30px; /* åœ†è§’æŒ‰é’®ç»„ */
}

.header-btn-primary {
  background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); /* ä¸»æŒ‰é’®æ©™è‰²æ¸å˜ */
}
```

#### ä¸»å†…å®¹åŒºå¸ƒå±€ (ç¬¬572-663è¡Œ)
```css
.lovable-main {
  flex: 1;
  display: flex; /* æ°´å¹³åˆ†å±å¸ƒå±€ */
  overflow: hidden;
}

.left-panel {
  width: 40%; /* å·¦ä¾§å  40% */
  border-radius: 0 var(--radius-lg) var(--radius-lg) 0; /* å³ä¾§åœ†è§’ */
  box-shadow: var(--shadow-md);
}

.resizer {
  width: 8px;
  background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, rgba(255, 140, 66, 0.12) 100%);
  cursor: col-resize; /* å¯è°ƒèŠ‚åˆ†éš”æ¡ */
}

.right-panel {
  width: 60%; /* å³ä¾§å  60% */
  border-radius: var(--radius-lg) 0 0 var(--radius-lg); /* å·¦ä¾§åœ†è§’ */
  box-shadow: var(--shadow-md);
}
```

#### Lovable ä¸»é¢˜å˜é‡
```css
/* ç¬¬400è¡Œå¯¼å…¥ */
@import '@/styles/lovable-theme.css';

/* ä½¿ç”¨çš„ CSS å˜é‡ï¼š */
--bg-primary, --text-primary, --border-primary
--spacing-xl, --spacing-md, --spacing-sm
--text-lg, --text-sm, --text-xs
--radius-lg, --shadow-md
--z-sticky, --transition-base
--code-bg
```

---

## äºŒã€æ—§æ–‡ä»¶ä¸šåŠ¡é€»è¾‘éœ€ä¿ç•™åŒºåŸŸï¼ˆæ¥è‡ªæ—§æ–‡ä»¶ 3461è¡Œï¼‰

### 2.1 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä»£ç æ®µ

| åŠŸèƒ½æ¨¡å— | è¡Œå·èŒƒå›´ | è¯´æ˜ |
|---------|---------|------|
| **imports å’Œç±»å‹å®šä¹‰** | 503-592 | Vueã€Routerã€APIã€Icon å¯¼å…¥åŠ Messageã€GenerationStepã€ToolCall ç­‰æ¥å£å®šä¹‰ |
| **çŠ¶æ€ç®¡ç†å’Œ refs** | 560-710 | appInfo, messages, isGenerating, EventSource æ§åˆ¶ã€æ–‡ä»¶ç”ŸæˆçŠ¶æ€ç­‰æ ¸å¿ƒå“åº”å¼æ•°æ® |
| **æƒé™å’Œ AI å¤´åƒè®¡ç®—** | 718-743 | isOwner, isAdmin, currentAiAvatar è®¡ç®—å±æ€§ |
| **æŒ‰é’®çŠ¶æ€æœº** | 745-771 | btnState (send/stop/continue/disabled) å’Œ primaryActionDisabled |
| **å¯¹è¯å†å²åŠ è½½** | 877-942 | loadChatHistory, loadMoreHistory å‡½æ•° |
| **åº”ç”¨ä¿¡æ¯è·å–** | 944-989 | fetchAppInfo å‡½æ•° |
| **å‘é€æ¶ˆæ¯å’Œä»£ç ç”Ÿæˆ** | 991-1065 | sendMessage, sendInitialMessage å‡½æ•° |
| **SSE ä»£ç ç”Ÿæˆæ ¸å¿ƒé€»è¾‘** | 1067-1432 | generateCode (EventSource æµå¼å“åº”å¤„ç†)ã€onToggleStream (åœæ­¢/ç»§ç»­) |
| **é”™è¯¯å¤„ç†** | 1434-1444 | handleError å‡½æ•° |
| **é¢„è§ˆå’Œä¸‹è½½éƒ¨ç½²** | 1446-1527 | updatePreview, downloadCode, deployApp |
| **ç‰ˆæœ¬ç®¡ç†** | 1529-1618 | showVersionHistory, fetchVersionList, handleRollback |
| **å¯è§†åŒ–ç¼–è¾‘å™¨** | 1670-1701 | toggleEditMode, clearSelectedElement, getInputPlaceholder |
| **æµå¼å†…å®¹è§£æ** | 1768-2620 | **æ ¸å¿ƒ SSE è§£æé€»è¾‘** - åŒ…æ‹¬ HTMLã€MULTI_FILEã€VUE_PROJECT ä¸‰ç§æ¨¡å¼çš„æµå¼å¤„ç† |
| **ç”Ÿå‘½å‘¨æœŸé’©å­** | 2623-2726 | onMounted, onUnmounted, watch è·¯ç”±åˆ‡æ¢ |

### 2.2 å¿…é¡»ä¿ç•™çš„æ ¸å¿ƒå‡½æ•°ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰

#### ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§ï¼ˆSSE ä»£ç ç”Ÿæˆæ ¸å¿ƒï¼‰
1. **generateCode** (1068-1362è¡Œ) - SSE EventSource è¿æ¥å’Œæµå¼å“åº”å¤„ç†
2. **parseStreamingContent** (1981-2018è¡Œ) - æµå¼å†…å®¹æ€»è°ƒåº¦å™¨
3. **parseSimpleCodeStreaming** (2249-2300è¡Œ) - HTML æ¨¡å¼ä»£ç è§£æ
4. **parseMultiFileStreaming** (2380-2409è¡Œ) - MULTI_FILE æ¨¡å¼ä»£ç è§£æ
5. **parseFileWriteToolCall** (2021-2048è¡Œ) - Vue é¡¹ç›®æ–‡ä»¶å†™å…¥è§£æ
6. **streamCodeContent** (2133-2211è¡Œ) - æ‰“å­—æœºæ•ˆæœæµå¼è¾“å‡º

#### ğŸŸ  é«˜ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·äº¤äº’å’ŒçŠ¶æ€ç®¡ç†ï¼‰
7. **sendMessage** (1016-1065è¡Œ) - å‘é€æ¶ˆæ¯å¹¶å¯åŠ¨ç”Ÿæˆ
8. **onToggleStream** (1365-1432è¡Œ) - åœæ­¢/ç»§ç»­ç”Ÿæˆæ§åˆ¶
9. **loadChatHistory** (878-937è¡Œ) - å¯¹è¯å†å²åŠ è½½
10. **fetchAppInfo** (945-989è¡Œ) - åº”ç”¨ä¿¡æ¯è·å–

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå†…å®¹è¿‡æ»¤å’ŒUIæ›´æ–°ï¼‰
11. **filterHtmlContent** (1769-1794è¡Œ) - HTML å†…å®¹è¿‡æ»¤
12. **filterOutCodeBlocks** (1797-1836è¡Œ) - MULTI_FILE å†…å®¹è¿‡æ»¤
13. **formatVueProjectContent** (1927-1977è¡Œ) - Vue é¡¹ç›®å†…å®¹æ ¼å¼åŒ–
14. **buildModifyDiffHtml** (1882-1924è¡Œ) - æ–‡ä»¶ä¿®æ”¹å·®å¼‚å¯¹æ¯” HTML ç”Ÿæˆ

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆè¾…åŠ©åŠŸèƒ½ï¼‰
15. **downloadCode** (1464-1499è¡Œ) - ä»£ç ä¸‹è½½
16. **deployApp** (1502-1527è¡Œ) - åº”ç”¨éƒ¨ç½²
17. **toggleEditMode** (1671-1689è¡Œ) - å¯è§†åŒ–ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
18. **ç‰ˆæœ¬ç®¡ç†ç›¸å…³å‡½æ•°** (1530-1604è¡Œ)

### 2.3 å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆéœ€ä¿ç•™ï¼‰

```javascript
// ç¬¬558è¡Œ - å¿…é¡»ä¿ç•™
const appGenerationStore = useAppGenerationStore()

// ç¬¬598-604è¡Œ - EventSource æ§åˆ¶çŠ¶æ€
const currentRunId = ref<string | null>(null)
const stoppedByUser = ref(false)
const lastUserMessage = ref('')
const currentAiMessageIndex = ref<number | null>(null)
const lastStoppedAt = ref<number>(0)

// ç¬¬606-618è¡Œ - SSE æ‰¹å¤„ç†ä¼˜åŒ–
let ssePendingChunks: string[] = []
let sseFullContent = ''
const sseFlushTimer = ref<any>(null)
const clearSseTimerAndBuffers = () => { ... }

// ç¬¬620-638è¡Œ - SSE æ€§èƒ½æŒ‡æ ‡
let sseMetrics: { ... } = { ... }

// ç¬¬640-710è¡Œ - ä»£ç ç”Ÿæˆæ–‡ä»¶çŠ¶æ€
const currentGeneratingFile = ref<GeneratedFile | null>(null)
const completedFiles = ref<GeneratedFile[]>([])
const simpleCodeFile = ref<GeneratedFile | null>(null)
const multiFiles = ref<GeneratedFile[]>([])
const multiFileContents = ref<Record<string, string>>({})
```

### 2.4 å·¥å…·å‡½æ•°ï¼ˆéœ€ä¿ç•™ï¼‰

```javascript
// ç¬¬1746-1766è¡Œ - æ–‡ä»¶åå’Œè¯­è¨€æ£€æµ‹
const extractFileName = (filePath: string): string => { ... }
const detectLanguage = (filePath: string): string => { ... }

// ç¬¬1838-1879è¡Œ - HTML è½¬ä¹‰å’Œ LCS å·®å¼‚ç®—æ³•
const escapeHtml = (s: string): string => { ... }
const diffLines = (oldStr: string, newStr: string): DiffOp[] => { ... }

// ç¬¬1606-1617è¡Œ - æ—¥æœŸæ ¼å¼åŒ–
const formatDateTime = (dateTime: string | undefined) => { ... }
```

---

## ä¸‰ã€è¯¦ç»†æ›¿æ¢æ­¥éª¤æ¸…å•

### é˜¶æ®µä¸€ï¼šåˆ›å»º composables æ–‡ä»¶ï¼ˆæ–°å»ºï¼‰

æ–°å¸ƒå±€ä½¿ç”¨äº†æ¨¡å—åŒ–çš„ composablesï¼Œéœ€è¦å°†æ—§æ–‡ä»¶çš„ä¸šåŠ¡é€»è¾‘æ‹†åˆ†åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š

#### 1. `useAppInfo.ts` (ç¬¬128è¡Œå¯¼å…¥)
**è´Ÿè´£ï¼š** åº”ç”¨ä¿¡æ¯ç®¡ç†
**ä»æ—§æ–‡ä»¶æå–ï¼š**
- appInfo, appId, isOwner, currentAiAvatar ç›¸å…³é€»è¾‘ (560-562, 718-743è¡Œ)
- fetchAppInfo å‡½æ•° (945-989è¡Œ)
- formatCodeGenType è¾…åŠ©å‡½æ•° (æ—§æ–‡ä»¶ç¬¬519è¡Œ)

#### 2. `useChatMessages.ts` (ç¬¬129è¡Œå¯¼å…¥)
**è´Ÿè´£ï¼š** èŠå¤©æ¶ˆæ¯ç®¡ç†
**ä»æ—§æ–‡ä»¶æå–ï¼š**
- messages, userInput, hasMoreHistory, loadingHistory çŠ¶æ€ (593-596, 681-684è¡Œ)
- loadChatHistory, addUserMessage, addAiMessagePlaceholder, updateAiMessage å‡½æ•° (878-937è¡Œ)
- scrollToBottom å‡½æ•° (1457-1461è¡Œ)

#### 3. `useCodeGeneration.ts` (ç¬¬130è¡Œå¯¼å…¥) â­â­â­ **æœ€æ ¸å¿ƒ**
**è´Ÿè´£ï¼š** SSE ä»£ç ç”Ÿæˆé€»è¾‘
**ä»æ—§æ–‡ä»¶æå–ï¼š**
- isGenerating, generationFinished, simpleCodeFile, multiFiles ç­‰çŠ¶æ€ (594, 690, 664-674è¡Œ)
- **generateCode å®Œæ•´å‡½æ•°** (1068-1362è¡Œ)
- **æ‰€æœ‰æµå¼è§£æå‡½æ•°** (1981-2620è¡Œ)
- **æ‰€æœ‰å†…å®¹è¿‡æ»¤å‡½æ•°** (1769-1977è¡Œ)
- currentRunId, stoppedByUser, ssePendingChunks ç­‰ SSE æ§åˆ¶çŠ¶æ€ (598-638è¡Œ)
- startCodeGeneration, stopGeneration, cleanup æŠ½è±¡æ¥å£

#### 4. `useAppDeployment.ts` (ç¬¬131è¡Œå¯¼å…¥)
**è´Ÿè´£ï¼š** éƒ¨ç½²å’Œä¸‹è½½ç®¡ç†
**ä»æ—§æ–‡ä»¶æå–ï¼š**
- downloading, deploying, deployModalVisible, deployUrl çŠ¶æ€ (693-695, 706è¡Œ)
- downloadCode å‡½æ•° (1464-1499è¡Œ)
- deployApp å‡½æ•° (1502-1527è¡Œ)

#### 5. `useVisualEditor.ts` (ç¬¬132è¡Œå¯¼å…¥)
**è´Ÿè´£ï¼š** å¯è§†åŒ–ç¼–è¾‘å™¨
**ä»æ—§æ–‡ä»¶æå–ï¼š**
- isEditMode, selectedElementInfo, visualEditor å®ä¾‹ (709-715è¡Œ)
- toggleEditMode, clearSelectedElement å‡½æ•° (1671-1693è¡Œ)
- getInputWithElementContext, afterMessageSent æŠ½è±¡æ¥å£ (æ—§æ–‡ä»¶ 1022-1047è¡Œçš„é€»è¾‘)

### é˜¶æ®µäºŒï¼šåˆ›å»ºå†…å®¹è¿‡æ»¤å·¥å…·æ–‡ä»¶ï¼ˆæ–°å»ºï¼‰

#### 6. `utils/contentFilters.ts` (ç¬¬135-139è¡Œå¯¼å…¥)
**ä»æ—§æ–‡ä»¶æå–ï¼š**
- filterHtmlContent å‡½æ•° (1769-1794è¡Œ)
- filterOutCodeBlocks å‡½æ•° (1797-1836è¡Œ)
- formatVueProjectContent å‡½æ•° (1927-1977è¡Œ)
- escapeHtml è¾…åŠ©å‡½æ•° (1839-1846è¡Œ)
- diffLines è¾…åŠ©å‡½æ•° (1849-1879è¡Œ)
- buildModifyDiffHtml å‡½æ•° (1882-1924è¡Œ)

### é˜¶æ®µä¸‰ï¼šåˆå¹¶ä¸»æ–‡ä»¶ script setup

#### 7. ä¸»æ–‡ä»¶ `<script setup>` éƒ¨åˆ† (ç¬¬114-396è¡Œ)

**ä¿ç•™æ–°æ–‡ä»¶çš„ç»“æ„ï¼Œæ’å…¥æ—§æ–‡ä»¶é€»è¾‘ï¼š**

```javascript
// æ–°æ–‡ä»¶å·²æœ‰çš„å¯¼å…¥ (115-146è¡Œ)
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useRoute } from 'vue-router'
import { message } from 'ant-design-vue'
import { ...Icons } from '@ant-design/icons-vue'
import { useAppInfo } from './composables/useAppInfo'
import { useChatMessages } from './composables/useChatMessages'
import { useCodeGeneration } from './composables/useCodeGeneration'
import { useAppDeployment } from './composables/useAppDeployment'
import { useVisualEditor } from './composables/useVisualEditor'
import { filterHtmlContent, ... } from './utils/contentFilters'
import ChatPanelLovable from './components/lovable/ChatPanelLovable.vue'
import CodePanelLovable from './components/lovable/CodePanelLovable.vue'
import { useLoginUserStore } from '@/stores/loginUser'

// âœ… éœ€è¦è¡¥å……çš„å¯¼å…¥ï¼ˆä»æ—§æ–‡ä»¶ï¼‰
import { useAppGenerationStore } from '@/stores/appGeneration' // æ—§558è¡Œ
import { VisualEditor } from '@/utils/visualEditor' // æ—§535è¡Œï¼ˆå¦‚æœ useVisualEditor æ²¡æœ‰å°è£…ï¼‰
import request from '@/request' // æ—§520è¡Œ
import { API_BASE_URL, getStaticPreviewUrl } from '@/config/env' // æ—§534è¡Œ

const route = useRoute()
const loginUserStore = useLoginUserStore()

// ========== åº”ç”¨ä¿¡æ¯ ==========
const { appInfo, appId, isOwner, currentAiAvatar, fetchAppInfo } = useAppInfo()

// ========== èŠå¤©æ¶ˆæ¯ ==========
const { messages, userInput, ... } = useChatMessages()

// ========== ä»£ç ç”Ÿæˆ ==========
const { isGenerating, generationFinished, ... } = useCodeGeneration()

// ========== éƒ¨ç½²ç®¡ç† ==========
const { downloading, deploying, ... } = useAppDeployment()

// ========== å¯è§†åŒ–ç¼–è¾‘å™¨ ==========
const { isEditMode, selectedElementInfo, ... } = useVisualEditor()

// ========== UI çŠ¶æ€ ==========
const currentView = ref<'preview' | 'code'>('preview') // æ–°æ–‡ä»¶ç¬¬203è¡Œ

// ========== æŒ‰é’®çŠ¶æ€ ==========
// âœ… éœ€è¦ä»æ—§æ–‡ä»¶è¡¥å…… btnState çŠ¶æ€æœºé€»è¾‘ (745-771è¡Œ)
type BtnState = 'send' | 'stop' | 'continue' | 'disabled'
const btnState = computed<BtnState>(() => {
  if (!isOwner.value) return 'disabled'
  if (isGenerating.value) return 'stop'
  const hasInput = !!(userInput.value && userInput.value.trim())
  if (stoppedByUser.value) {
    if (hasInput) return 'send'
    if (lastUserMessage.value && currentAiMessageIndex.value !== null) return 'continue'
    return 'disabled'
  }
  return hasInput ? 'send' : 'disabled'
})

// ========== äº‹ä»¶å¤„ç† ==========
// ä¿ç•™æ–°æ–‡ä»¶çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œå¿…è¦æ—¶å¢å¼º
const sendMessage = async () => {
  // âœ… åˆå¹¶æ—§æ–‡ä»¶ 1016-1065è¡Œ çš„å®Œæ•´é€»è¾‘
  // åŒ…æ‹¬ï¼šå¯è§†åŒ–ç¼–è¾‘å™¨å…ƒç´ ä¸Šä¸‹æ–‡å¢å¼ºã€SSE ç”Ÿæˆå¯åŠ¨
}

// ========== åˆ†éš”æ è°ƒæ•´ ==========
// ä¿ç•™æ–°æ–‡ä»¶ 341-372è¡Œ

// ========== ç”Ÿå‘½å‘¨æœŸ ==========
onMounted(async () => {
  await fetchAppInfo()
  await loadChatHistory(...)

  // âœ… è¡¥å……æ—§æ–‡ä»¶ 2624-2656è¡Œ çš„é€»è¾‘
  // - æ¢å¤ç”ŸæˆçŠ¶æ€ï¼ˆå¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼‰
  // - iframe æ¶ˆæ¯ç›‘å¬
  // - beforeunload äº‹ä»¶ç›‘å¬
})

onUnmounted(() => {
  cleanupCodeGeneration()

  // âœ… è¡¥å……æ—§æ–‡ä»¶ 2658-2676è¡Œ çš„æ¸…ç†é€»è¾‘
  // - æ¸…ç†å®šæ—¶å™¨
  // - ä¸å…³é—­ EventSourceï¼ˆç”±å…¨å±€ store ç®¡ç†ï¼‰
})

// âœ… è¡¥å……æ—§æ–‡ä»¶ 2679-2726è¡Œ çš„è·¯ç”±ç›‘å¬
watch(
  () => route.params.id,
  async (newId, oldId) => { ... }
)
```

### é˜¶æ®µå››ï¼šæ›¿æ¢ template éƒ¨åˆ†

#### 8. HTML æ¨¡æ¿å®Œå…¨æ›¿æ¢

**æ“ä½œï¼š** å°†æ–°æ–‡ä»¶çš„ `<template>` (1-112è¡Œ) å®Œå…¨æ›¿æ¢æ—§æ–‡ä»¶çš„ `<template>` (1-500è¡Œ)

**å…³é”®å˜æ›´ç‚¹ï¼š**
- âœ… ç§»é™¤æ—§çš„ `.header-bar` ç»“æ„ â†’ ä½¿ç”¨æ–°çš„ `.lovable-header`
- âœ… ç§»é™¤æ—§çš„ `.main-content` â†’ ä½¿ç”¨æ–°çš„ `.lovable-main` ä¸‰æ å¸ƒå±€
- âœ… ç§»é™¤æ—§çš„ `.chat-section` å’Œ `.code-generation-section` â†’ ä½¿ç”¨ `ChatPanelLovable` å’Œ `CodePanelLovable` ç»„ä»¶
- âœ… ä¿ç•™æ—§æ–‡ä»¶çš„å¼¹çª—ç»„ä»¶ï¼ˆ379-499è¡Œï¼‰ï¼š
  - `<AppDetailModal>` (380-386è¡Œ)
  - `<DeploySuccessModal>` (389-393è¡Œ)
  - ç‰ˆæœ¬å†å²å¼¹çª— (396-499è¡Œ)

**æœ€ç»ˆ template ç»“æ„ï¼š**
```vue
<template>
  <div class="lovable-app-chat-page">
    <!-- æ–°ï¼šLovable é£æ ¼ header -->
    <header class="lovable-header">...</header>

    <!-- æ–°ï¼šå·¦å³åˆ†å± main -->
    <main class="lovable-main">
      <div class="left-panel"><ChatPanelLovable /></div>
      <div class="resizer"></div>
      <div class="right-panel"><CodePanelLovable /></div>
    </main>

    <!-- æ—§ï¼šä¿ç•™å¼¹çª—ç»„ä»¶ -->
    <AppDetailModal />
    <DeploySuccessModal />
    <a-modal>ç‰ˆæœ¬å†å²</a-modal>
    <a-modal>ç‰ˆæœ¬è¯¦æƒ…</a-modal>
  </div>
</template>
```

### é˜¶æ®µäº”ï¼šæ›¿æ¢ style éƒ¨åˆ†

#### 9. CSS æ ·å¼å®Œå…¨æ›¿æ¢

**æ“ä½œï¼š** å°†æ–°æ–‡ä»¶çš„ `<style scoped>` (398-721è¡Œ) å®Œå…¨æ›¿æ¢æ—§æ–‡ä»¶çš„ `<style scoped>` (2729-3458è¡Œ)

**ä¿ç•™æ—§æ–‡ä»¶çš„ç‰¹æ®Šæ ·å¼ï¼š**
- **å·¥å…·æ­¥éª¤åŒºåŸŸæ ·å¼** (2863-3022è¡Œ) - å¦‚æœ ChatPanelLovable å†…éƒ¨éœ€è¦æ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯
- **ç‰ˆæœ¬ç®¡ç†æ ·å¼** (3405-3457è¡Œ)
- **å¯è§†åŒ–ç¼–è¾‘å™¨å…ƒç´ æ ·å¼** (3305-3404è¡Œ)

**æœ€ç»ˆ style ç»“æ„ï¼š**
```vue
<style scoped>
/* æ–°æ–‡ä»¶å®Œæ•´æ ·å¼ (398-721è¡Œ) */
@import '@/styles/lovable-theme.css';

.lovable-app-chat-page { ... }
.lovable-header { ... }
.lovable-main { ... }
.left-panel, .right-panel, .resizer { ... }
å“åº”å¼è®¾è®¡ { ... }

/* æ—§æ–‡ä»¶ä¿ç•™æ ·å¼ï¼ˆé€‰æ‹©æ€§ï¼‰*/
.version-item { ... }
.version-info { ... }
.edit-mode-active { ... }
.selected-element-alert { ... }
</style>
```

---

## å››ã€å…³é”®éš¾ç‚¹å’Œæ³¨æ„äº‹é¡¹

### 4.1 SSE ä»£ç ç”Ÿæˆé€»è¾‘è¿ç§» âš ï¸

**éš¾ç‚¹ï¼š** æ—§æ–‡ä»¶çš„ `generateCode` å‡½æ•°ï¼ˆ1068-1362è¡Œï¼‰é«˜åº¦ä¾èµ–ï¼š
- `appGenerationStore.eventSource` å…¨å±€ EventSource ç®¡ç†
- `parseStreamingContent` æµå¼è§£æè°ƒåº¦
- ä¸‰ç§æ¨¡å¼çš„å†…å®¹è¿‡æ»¤ï¼ˆHTMLã€MULTI_FILEã€VUE_PROJECTï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
1. åœ¨ `useCodeGeneration` composable ä¸­å°è£…å®Œæ•´çš„ SSE é€»è¾‘
2. ä¿æŒ `appGenerationStore` çš„å…¨å±€çŠ¶æ€ç®¡ç†
3. ç¡®ä¿ `parseStreamingContent` åŠå…¶æ‰€æœ‰å­å‡½æ•°ï¼ˆ`parseSimpleCodeStreaming`ã€`parseMultiFileStreaming` ç­‰ï¼‰éƒ½è¿ç§»åˆ° composable ä¸­

### 4.2 ç»„ä»¶é—´æ•°æ®ä¼ é€’ âš ï¸

**éš¾ç‚¹ï¼š** `ChatPanelLovable` å’Œ `CodePanelLovable` éœ€è¦è®¿é—®å¤§é‡çŠ¶æ€

**æ–°æ–‡ä»¶å·²ä¼ é€’çš„ propsï¼š**

**ChatPanelLovable æ¥æ”¶ï¼š**
```vue
<ChatPanelLovable
  :messages="messages"
  :hasMoreHistory="hasMoreHistory"
  :loadingHistory="loadingHistory"
  :userAvatar="loginUserStore.loginUser.userAvatar"
  :aiAvatar="currentAiAvatar"
  :selectedElementInfo="selectedElementInfo"
  v-model:userInput="userInput"
  :isOwner="isOwner"
  :isGenerating="isGenerating"
  :primaryActionDisabled="primaryActionDisabled"
  :primaryActionTitle="primaryActionTitle"
  @load-more="loadMoreHistory"
  @clear-selected-element="clearSelectedElement"
  @primary-action="onPrimaryActionClick"
  @keydown="onInputKeydown"
/>
```

**CodePanelLovable æ¥æ”¶ï¼š**
```vue
<CodePanelLovable
  :currentView="currentView"
  :codeGenType="appInfo?.codeGenType"
  :showPreview="generationFinished"
  :previewUrl="previewUrl"
  :simpleCodeFile="simpleCodeFile"
  :multiFiles="completedFiles"
  :activeFileKey="activeFileKey"
  :generationFinished="generationFinished"
  @preview-loaded="onPreviewLoaded"
  @update:activeFileKey="activeFileKey = $event"
/>
```

**éœ€è¦è¡¥å……ä¼ é€’çš„æ•°æ®ï¼š**
- `currentGeneratingFile` - å½“å‰ç”Ÿæˆä¸­çš„æ–‡ä»¶ï¼ˆVue é¡¹ç›®æ¨¡å¼ï¼‰
- `isEditMode` - å¯è§†åŒ–ç¼–è¾‘æ¨¡å¼çŠ¶æ€
- `toggleEditMode` - åˆ‡æ¢ç¼–è¾‘æ¨¡å¼çš„å›è°ƒ

### 4.3 å…¨å±€ store çŠ¶æ€åŒæ­¥ âš ï¸

**æ—§æ–‡ä»¶çš„å…³é”®é€»è¾‘ï¼ˆ828-875è¡Œï¼‰ï¼š**
```javascript
// åŒæ­¥UIçŠ¶æ€åˆ°å…¨å±€store
const syncUIStateToStore = () => {
  if (!appGenerationStore.isGenerating) return
  appGenerationStore.updateUIState({
    messages: messages.value,
    currentAiMessageIndex: currentAiMessageIndex.value,
    lastUserMessage: lastUserMessage.value,
    completedFiles: completedFiles.value,
    currentGeneratingFile: currentGeneratingFile.value,
    simpleCodeFile: simpleCodeFile.value,
    multiFiles: multiFiles.value,
    currentMultiFile: currentMultiFile.value,
    multiFileContents: multiFileContents.value,
    generationFinished: generationFinished.value,
  })
}

// ä»å…¨å±€storeæ¢å¤UIçŠ¶æ€
const restoreUIStateFromStore = () => { ... }
```

**è§£å†³æ–¹æ¡ˆï¼š**
åœ¨ `useCodeGeneration` composable ä¸­å®ç°è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œç¡®ä¿é¡µé¢åˆ‡æ¢æ—¶ç”ŸæˆçŠ¶æ€ä¸ä¸¢å¤±

### 4.4 å“åº”å¼å¸ƒå±€æµ‹è¯• âš ï¸

**æ–°æ–‡ä»¶çš„å“åº”å¼è®¾è®¡ï¼ˆ666-714è¡Œï¼‰ï¼š**
- 1024px ä»¥ä¸‹ï¼šå·¦å³å„å  50%ï¼Œéšè—æŒ‰é’®æ–‡å­—
- 768px ä»¥ä¸‹ï¼šåˆ‡æ¢ä¸ºä¸Šä¸‹å¸ƒå±€ï¼Œresizer å˜ä¸ºæ°´å¹³æ‹–åŠ¨

**éœ€è¦æµ‹è¯•ï¼š**
- ç§»åŠ¨ç«¯ä¸Šä¸‹æ‹–åŠ¨åˆ†éš”æ¡åŠŸèƒ½
- ChatPanelLovable å’Œ CodePanelLovable åœ¨å°å±å¹•ä¸‹çš„é€‚é…

---

## äº”ã€æ›¿æ¢æ‰§è¡Œé¡ºåºå»ºè®®

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º composablesï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰

1. âœ… **åˆ›å»º `useCodeGeneration.ts`** (æœ€æ ¸å¿ƒï¼Œå…ˆå®Œæˆ)
   - è¿ç§»æ‰€æœ‰ SSE ç›¸å…³é€»è¾‘
   - è¿ç§»æ‰€æœ‰æµå¼è§£æå‡½æ•°
   - è¿ç§»æ‰€æœ‰å†…å®¹è¿‡æ»¤å‡½æ•°

2. âœ… **åˆ›å»º `utils/contentFilters.ts`** (è¾…åŠ© useCodeGeneration)
   - å¯¼å‡º filterHtmlContentã€filterOutCodeBlocksã€formatVueProjectContent

3. âœ… **åˆ›å»º `useChatMessages.ts`**
   - è¿ç§»æ¶ˆæ¯ç®¡ç†é€»è¾‘

4. âœ… **åˆ›å»º `useAppInfo.ts`**
   - è¿ç§»åº”ç”¨ä¿¡æ¯ç®¡ç†

5. âœ… **åˆ›å»º `useAppDeployment.ts`**
   - è¿ç§»éƒ¨ç½²å’Œä¸‹è½½é€»è¾‘

6. âœ… **åˆ›å»º `useVisualEditor.ts`**
   - è¿ç§»å¯è§†åŒ–ç¼–è¾‘å™¨é€»è¾‘

### ç¬¬äºŒæ­¥ï¼šåˆ›å»º Lovable ç»„ä»¶

7. âœ… **åˆ›å»º `ChatPanelLovable.vue`**
   - å‚è€ƒæ—§æ–‡ä»¶çš„ `.chat-section` ç»“æ„ï¼ˆ2777-3023è¡Œï¼‰
   - ä½¿ç”¨æ–°çš„ Lovable æ ·å¼

8. âœ… **åˆ›å»º `CodePanelLovable.vue`**
   - å‚è€ƒæ—§æ–‡ä»¶çš„ `.code-generation-section` ç»“æ„ï¼ˆ3068-3260è¡Œï¼‰
   - æ ¹æ® `currentView` åˆ‡æ¢ä»£ç /é¢„è§ˆè§†å›¾

### ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶ä¸»æ–‡ä»¶

9. âœ… **æ›¿æ¢ `AppChatPage.vue` çš„ template**
   - ä½¿ç”¨æ–°æ–‡ä»¶çš„ 1-112è¡Œ
   - ä¿ç•™æ—§æ–‡ä»¶çš„å¼¹çª—ç»„ä»¶ (379-499è¡Œ)

10. âœ… **æ›¿æ¢ `AppChatPage.vue` çš„ script**
    - ä½¿ç”¨æ–°æ–‡ä»¶çš„ç»“æ„æ¡†æ¶
    - è¡¥å……æ—§æ–‡ä»¶çš„ btnStateã€è·¯ç”±ç›‘å¬ã€ç”Ÿå‘½å‘¨æœŸé€»è¾‘

11. âœ… **æ›¿æ¢ `AppChatPage.vue` çš„ style**
    - ä½¿ç”¨æ–°æ–‡ä»¶çš„ 398-721è¡Œ
    - é€‰æ‹©æ€§ä¿ç•™æ—§æ–‡ä»¶çš„ç‰¹æ®Šæ ·å¼ï¼ˆç‰ˆæœ¬ç®¡ç†ã€å¯è§†åŒ–ç¼–è¾‘å™¨ï¼‰

### ç¬¬å››æ­¥ï¼šæµ‹è¯•å’Œè°ƒè¯•

12. âœ… **åŠŸèƒ½æµ‹è¯•**
    - SSE ä»£ç ç”Ÿæˆï¼ˆHTMLã€MULTI_FILEã€VUE_PROJECT ä¸‰ç§æ¨¡å¼ï¼‰
    - åœæ­¢/ç»§ç»­ç”Ÿæˆ
    - å¯è§†åŒ–ç¼–è¾‘å™¨å…ƒç´ é€‰æ‹©
    - é¢„è§ˆ/ä»£ç è§†å›¾åˆ‡æ¢
    - åˆ†éš”æ¡æ‹–åŠ¨è°ƒæ•´
    - ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š

13. âœ… **æ ·å¼æµ‹è¯•**
    - Lovable ä¸»é¢˜æ•ˆæœ
    - å“åº”å¼å¸ƒå±€ï¼ˆ1024pxã€768px æ–­ç‚¹ï¼‰
    - ç§»åŠ¨ç«¯é€‚é…

---

## å…­ã€é£é™©è¯„ä¼°å’Œå›æ»šè®¡åˆ’

### é«˜é£é™©ç‚¹

1. **SSE ä»£ç ç”Ÿæˆä¸­æ–­** - å¦‚æœè¿ç§»ä¸å®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´ä»£ç ç”ŸæˆåŠŸèƒ½å¤±æ•ˆ
   - **å›æ»šæ–¹æ¡ˆï¼š** ä¿ç•™æ—§æ–‡ä»¶å¤‡ä»½ï¼Œå¿«é€Ÿæ¢å¤

2. **å…¨å±€ store çŠ¶æ€ä¸¢å¤±** - é¡µé¢åˆ‡æ¢åç”ŸæˆçŠ¶æ€æ— æ³•æ¢å¤
   - **å›æ»šæ–¹æ¡ˆï¼š** ç¡®ä¿ `syncUIStateToStore` å’Œ `restoreUIStateFromStore` é€»è¾‘å®Œæ•´è¿ç§»

3. **ç»„ä»¶é€šä¿¡å¤±è´¥** - ChatPanelLovable/CodePanelLovable æ— æ³•æ­£ç¡®æ¥æ”¶/å‘é€æ•°æ®
   - **å›æ»šæ–¹æ¡ˆï¼š** å…ˆç”¨ç®€åŒ–ç‰ˆç»„ä»¶æµ‹è¯•ï¼Œé€æ­¥å¢åŠ  props å’Œ events

### å»ºè®®

- æ¯ä¸ª composable åˆ›å»ºåç«‹å³å•å…ƒæµ‹è¯•
- åˆ†æ”¯å¼€å‘ï¼Œä¸»åˆ†æ”¯ä¿ç•™æ—§ä»£ç 
- ä½¿ç”¨ feature toggleï¼Œå¯ä»¥åœ¨æ–°æ—§å¸ƒå±€ä¹‹é—´åˆ‡æ¢

---

## ä¸ƒã€æ€»ç»“

### æ–°å¸ƒå±€ä¼˜åŠ¿

âœ… **æ¨¡å—åŒ–æ¶æ„** - composables åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œæ˜“äºç»´æŠ¤
âœ… **Lovable ä¸»é¢˜** - ç°ä»£åŒ–çš„æ¸å˜æ©™è‰²è®¾è®¡ï¼Œè§†è§‰å†²å‡»åŠ›å¼º
âœ… **å·¦å³åˆ†å±** - ChatGPT é£æ ¼èŠå¤© + VS Code é£æ ¼ä»£ç ç¼–è¾‘
âœ… **å¯è°ƒèŠ‚åˆ†éš”æ¡** - ç”¨æˆ·å¯è‡ªå®šä¹‰å·¦å³é¢æ¿å®½åº¦
âœ… **ç»„ä»¶åŒ–** - ChatPanelLovable/CodePanelLovable å¯å¤ç”¨

### éœ€è¦ä¿ç•™çš„æ—§é€»è¾‘ï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰

âš ï¸ **SSE ä»£ç ç”Ÿæˆå¼•æ“** - 1068-2620è¡Œï¼Œæ”¯æŒä¸‰ç§æ¨¡å¼çš„æµå¼è§£æ
âš ï¸ **å…¨å±€ store çŠ¶æ€ç®¡ç†** - ç¡®ä¿é¡µé¢åˆ‡æ¢æ—¶ç”Ÿæˆä¸ä¸­æ–­
âš ï¸ **å†…å®¹è¿‡æ»¤ç®—æ³•** - HTMLã€MULTI_FILEã€VUE_PROJECT çš„ä¸“ç”¨è¿‡æ»¤å™¨
âš ï¸ **å¯è§†åŒ–ç¼–è¾‘å™¨** - å…ƒç´ é€‰æ‹©å’Œä¸Šä¸‹æ–‡å¢å¼ºæç¤ºè¯
âš ï¸ **ç‰ˆæœ¬ç®¡ç†** - å†å²ç‰ˆæœ¬æŸ¥çœ‹å’Œå›æ»š

### é¢„ä¼°å·¥ä½œé‡

| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ |
|------|---------|
| åˆ›å»º 6 ä¸ª composables | 8-12 å°æ—¶ |
| åˆ›å»º 2 ä¸ª Lovable ç»„ä»¶ | 6-8 å°æ—¶ |
| åˆå¹¶ä¸»æ–‡ä»¶ | 4-6 å°æ—¶ |
| æµ‹è¯•å’Œè°ƒè¯• | 6-10 å°æ—¶ |
| **æ€»è®¡** | **24-36 å°æ—¶** |

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2025-10-11
**åˆ†æå¯¹è±¡ï¼š** AppChatPage.vue (æ–° 722è¡Œ) vs AppChatPage.old-optimized.vue (æ—§ 3461è¡Œ)
