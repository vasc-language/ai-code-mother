# AppChatPage åç«¯æ¥å£å¯¹æ¥å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºæ ¸å¿ƒ Composables

#### **useCodeGeneration.ts** - SSE æµå¼ä»£ç ç”Ÿæˆ
- âœ… SSE è¿æ¥ç®¡ç†ï¼ˆä½¿ç”¨ @microsoft/fetch-event-sourceï¼‰
- âœ… å®æ—¶æµå¼æ¥æ”¶ AI ç”Ÿæˆçš„ä»£ç 
- âœ… è‡ªåŠ¨è§£æå•æ–‡ä»¶ï¼ˆHTMLï¼‰å’Œå¤šæ–‡ä»¶é¡¹ç›®
- âœ… æ–‡ä»¶å†…å®¹è§£æï¼ˆæ”¯æŒ Markdown ä»£ç å—æ ¼å¼ï¼‰
- âœ… é¢„è§ˆ URL ç”Ÿæˆï¼ˆBlob URLï¼‰
- âœ… åœæ­¢ç”ŸæˆåŠŸèƒ½
- âœ… èµ„æºæ¸…ç†æœºåˆ¶

**å…³é”®åŠŸèƒ½ï¼š**
```typescript
startCodeGeneration(appId, message, codeGenType, onMessageUpdate, onComplete)
stopGeneration()
parseGeneratedContent(content, codeGenType)
createPreviewUrl(htmlContent)
```

#### **useAppDeployment.ts** - éƒ¨ç½²å’Œä¸‹è½½
- âœ… ä»£ç ä¸‹è½½åŠŸèƒ½ï¼ˆZIP æ–‡ä»¶ï¼‰
- âœ… åº”ç”¨éƒ¨ç½²åˆ°äº‘ç«¯
- âœ… éƒ¨ç½²çŠ¶æ€ç®¡ç†
- âœ… æ–‡ä»¶ä¸‹è½½å¤„ç†

#### **useAppInfo.ts** - åº”ç”¨ä¿¡æ¯ç®¡ç†
- âœ… è·å–åº”ç”¨è¯¦æƒ…
- âœ… æƒé™åˆ¤æ–­ï¼ˆisOwner, isAdminï¼‰
- âœ… AI æ¨¡å‹å¤´åƒåŠ¨æ€æ˜¾ç¤º
- âœ… æ”¯æŒå¤šç§ AI æ¨¡å‹å›¾æ ‡

#### **useChatMessages.ts** - èŠå¤©æ¶ˆæ¯ç®¡ç†
- âœ… æ¶ˆæ¯åˆ—è¡¨ç»´æŠ¤
- âœ… æ·»åŠ ç”¨æˆ·/AI æ¶ˆæ¯
- âœ… æ¶ˆæ¯æ›´æ–°ï¼ˆå®æ—¶æµå¼ï¼‰
- âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- âœ… èŠå¤©å†å²åŠ è½½

### 2. æ•´åˆåˆ° AppChatPage.vue

#### **å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼š**

1. **é¡µé¢åˆå§‹åŒ–**
   - è·å–åº”ç”¨è¯¦æƒ…ä¿¡æ¯
   - åŠ è½½èŠå¤©å†å²ï¼ˆTODOï¼‰
   - åˆå§‹åŒ– UI çŠ¶æ€

2. **å‘é€æ¶ˆæ¯æµç¨‹**
   ```
   ç”¨æˆ·è¾“å…¥ â†’ ç‚¹å‡»å‘é€ â†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ â†’
   å¯åŠ¨ SSE è¿æ¥ â†’ å®æ—¶æ¥æ”¶ AI å“åº” â†’
   è§£æä»£ç æ–‡ä»¶ â†’ åˆ›å»ºé¢„è§ˆ URL â†’ æ˜¾ç¤ºç»“æœ
   ```

3. **ä»£ç ç”Ÿæˆæµç¨‹**
   - SSE æµå¼æ¥æ”¶å†…å®¹
   - å®æ—¶æ›´æ–° AI æ¶ˆæ¯æ˜¾ç¤º
   - è‡ªåŠ¨è§£æ HTML/å¤šæ–‡ä»¶æ ¼å¼
   - ç”Ÿæˆé¢„è§ˆé“¾æ¥
   - æ–‡ä»¶æ ‘å±•ç¤º

4. **ä¸‹è½½/éƒ¨ç½²åŠŸèƒ½**
   - ä¸‹è½½ï¼šç›´æ¥ä¸‹è½½ ZIP æ–‡ä»¶
   - éƒ¨ç½²ï¼šè°ƒç”¨åç«¯ APIï¼Œè·å–éƒ¨ç½² URL

### 3. æŠ€æœ¯å®ç°ç»†èŠ‚

#### **SSE è¿æ¥ï¼ˆServer-Sent Eventsï¼‰**
```typescript
// è¿æ¥åç«¯ SSE ç«¯ç‚¹
GET /app/chat/gen/code?appId=${appId}&userMessage=${message}

// å®æ—¶æ¥æ”¶æ•°æ®æµ
onmessage: (event) => {
  accumulatedContent += event.data
  onMessageUpdate(accumulatedContent)
}
```

#### **æ–‡ä»¶è§£æé€»è¾‘**
- **HTML å•æ–‡ä»¶ï¼š** ä» Markdown ä»£ç å—æå– HTML
- **å¤šæ–‡ä»¶é¡¹ç›®ï¼š** è§£æ `### filename` æ ¼å¼çš„æ–‡ä»¶å—
- **è¯­è¨€æ£€æµ‹ï¼š** æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨è¯†åˆ«è¯­è¨€

#### **é¢„è§ˆæœºåˆ¶**
- ä½¿ç”¨ Blob URL åˆ›å»ºä¸´æ—¶é¢„è§ˆé“¾æ¥
- iframe æ–¹å¼åŠ è½½ HTML é¢„è§ˆ
- è‡ªåŠ¨èµ„æºæ¸…ç†ï¼ˆonUnmountedï¼‰

### 4. æ•°æ®æµè½¬

```
AppChatPage.vue
â”œâ”€â”€ useAppInfo â†’ åº”ç”¨ä¿¡æ¯
â”œâ”€â”€ useChatMessages â†’ æ¶ˆæ¯ç®¡ç†
â”œâ”€â”€ useCodeGeneration â†’ ä»£ç ç”Ÿæˆ
â”‚   â”œâ”€â”€ SSE è¿æ¥
â”‚   â”œâ”€â”€ æ–‡ä»¶è§£æ
â”‚   â””â”€â”€ é¢„è§ˆç”Ÿæˆ
â””â”€â”€ useAppDeployment â†’ ä¸‹è½½/éƒ¨ç½²

â†“ æ•°æ®ä¼ é€’åˆ°å­ç»„ä»¶

CodePanelLovable.vue
â”œâ”€â”€ currentView (preview/code)
â”œâ”€â”€ simpleCodeFile (HTML)
â”œâ”€â”€ multiFiles (å¤šæ–‡ä»¶)
â”œâ”€â”€ previewUrl (é¢„è§ˆé“¾æ¥)
â””â”€â”€ activeFileKey (å½“å‰æ–‡ä»¶)
```

### 5. å®‰è£…çš„ä¾èµ–

```json
{
  "@microsoft/fetch-event-source": "^2.0.1"
}
```

## ğŸ“‹ å¾…å®Œæˆäº‹é¡¹ï¼ˆTODOï¼‰

1. **èŠå¤©å†å²åŠ è½½**
   - åœ¨ `onMounted` ä¸­è°ƒç”¨ `loadChatHistory`
   - å®ç°å†å²æ¶ˆæ¯è¿‡æ»¤é€»è¾‘

2. **åº”ç”¨è¯¦æƒ…å¼¹çª—**
   - åˆ›å»º AppDetailModal ç»„ä»¶
   - å®ç°è¯¦æƒ…å±•ç¤º

3. **ç‰ˆæœ¬å†å²åŠŸèƒ½**
   - é›†æˆ useVersionManagement
   - å®ç°ç‰ˆæœ¬å›æ»š

4. **é”™è¯¯å¤„ç†ä¼˜åŒ–**
   - æ·»åŠ é‡è¯•æœºåˆ¶
   - æ›´è¯¦ç»†çš„é”™è¯¯æç¤º

## ğŸ¯ æ ¸å¿ƒ API æ¥å£

### å·²å¯¹æ¥æ¥å£ï¼š

1. **GET /app/get/vo** - è·å–åº”ç”¨è¯¦æƒ…
2. **GET /app/chat/gen/code** - SSE æµå¼ä»£ç ç”Ÿæˆ
3. **GET /app/download/{appId}** - ä¸‹è½½ä»£ç 
4. **POST /app/deploy** - éƒ¨ç½²åº”ç”¨

### å¾…å¯¹æ¥æ¥å£ï¼š

1. **GET /app/chat/history** - èŠå¤©å†å²
2. **POST /app/chat/stop** - åœæ­¢ç”Ÿæˆ

## ğŸš€ ä½¿ç”¨æ–¹å¼

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
cd ai-code-mother-frontend
npm install  # å®‰è£…æ–°ä¾èµ–
npm run dev  # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```

### æµ‹è¯•æµç¨‹
1. è®¿é—®åº”ç”¨ç”Ÿæˆé¡µé¢ï¼š`/app/chat/{appId}`
2. è¾“å…¥æç¤ºè¯ï¼Œç‚¹å‡»å‘é€
3. è§‚å¯Ÿ SSE æµå¼ç”Ÿæˆè¿‡ç¨‹
4. æŸ¥çœ‹æ–‡ä»¶æ ‘å’Œä»£ç é¢„è§ˆ
5. åˆ‡æ¢é¢„è§ˆ/ä»£ç è§†å›¾
6. æµ‹è¯•ä¸‹è½½å’Œéƒ¨ç½²åŠŸèƒ½

## ğŸ“ æ¶‰åŠæ–‡ä»¶

### æ–°åˆ›å»ºï¼š
- `src/pages/app/composables/useCodeGeneration.ts`

### å·²å­˜åœ¨ï¼ˆå·²ä¼˜åŒ–ï¼‰ï¼š
- `src/pages/app/composables/useAppInfo.ts`
- `src/pages/app/composables/useChatMessages.ts`
- `src/pages/app/composables/useAppDeployment.ts`

### ä¸»è¦ä¿®æ”¹ï¼š
- `src/pages/app/AppChatPage.vue` - å®Œæ•´åç«¯å¯¹æ¥
- `src/pages/app/components/lovable/CodePanelLovable.vue` - VSCode é£æ ¼å®ç°

## ğŸ¨ UI ç‰¹æ€§

### å½“å‰é¡µé¢ï¼šAppChatPage.vue
- âœ… Lovable æ©™è‰²ä¸»é¢˜
- âœ… é¡¶éƒ¨å¯¼èˆªæ ï¼ˆè¯¦æƒ…ã€å†å²ã€ä¸‹è½½ã€éƒ¨ç½²ï¼‰
- âœ… é¢„è§ˆ/ä»£ç è§†å›¾åˆ‡æ¢
- âœ… å·¦å³åˆ†æ å¯æ‹–æ‹½è°ƒèŠ‚
- âœ… åœ†è§’å’Œæ¸å˜æ•ˆæœ

### ä»£ç é¢æ¿ï¼šCodePanelLovable.vue
- âœ… VSCode æ·±è‰²ä¸»é¢˜
- âœ… å·¦ä¾§æ–‡ä»¶èµ„æºç®¡ç†å™¨
- âœ… å³ä¾§ä»£ç ç¼–è¾‘å™¨
- âœ… æ–‡ä»¶æ ‡ç­¾æ 
- âœ… çŠ¶æ€æ 
- âœ… è¯­æ³•é«˜äº®

## âš¡ æ€§èƒ½ä¼˜åŒ–

1. **SSE è¿æ¥ç®¡ç†**
   - ä½¿ç”¨ AbortController æ§åˆ¶è¿æ¥
   - ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†

2. **Blob URL ç®¡ç†**
   - åˆ›å»ºæ–° URL å‰å…ˆæ¸…ç†æ—§çš„
   - é¿å…å†…å­˜æ³„æ¼

3. **æ¶ˆæ¯æ»šåŠ¨ä¼˜åŒ–**
   - ä½¿ç”¨ nextTick ç¡®ä¿ DOM æ›´æ–°åæ»šåŠ¨
   - ä»…åœ¨æ–°æ¶ˆæ¯æ—¶è§¦å‘æ»šåŠ¨

## ğŸ”§ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ SSE è¿æ¥
```javascript
// Chrome DevTools â†’ Network â†’ Filter: event-stream
// æŸ¥çœ‹å®æ—¶æ•°æ®æµ
```

### æµ‹è¯•ä»£ç ç”Ÿæˆ
```javascript
// æ§åˆ¶å°æµ‹è¯•
console.log(simpleCodeFile.value)
console.log(multiFiles.value)
console.log(previewUrl.value)
```

---

**æ€»ç»“ï¼š** AppChatPage.vue å·²å®Œæˆæ ¸å¿ƒåç«¯æ¥å£å¯¹æ¥ï¼Œæ”¯æŒå®Œæ•´çš„ä»£ç ç”Ÿæˆã€é¢„è§ˆã€ä¸‹è½½å’Œéƒ¨ç½²æµç¨‹ã€‚æ‰€æœ‰åŠŸèƒ½æ¨¡å—åŒ–ä¸º composablesï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚
