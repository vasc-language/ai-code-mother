# AICodeHub Nginx 配置文件
# 适用于 Ubuntu 服务器部署
# 位置: /etc/nginx/sites-available/aicodehub

server {
    listen 80;
    server_name yourname.com www.yourname.com;  # 修改为你的域名

    # 访问日志
    access_log /var/log/nginx/aicodehub_access.log;
    error_log /var/log/nginx/aicodehub_error.log;

    # 客户端最大上传大小
    client_max_body_size 50M;

    # 部署作品短链：/{deployKey} -> /{deployKey}/
    # deployKey 约定 6 位，且至少包含一个大写字母或数字
    location ~ ^/(?=[^/]*[A-Z0-9])[A-Za-z0-9]{6}$ {
        return 301 $uri/;
    }

    # 部署作品访问：/{deployKey}/... -> 后端静态资源接口
    location ~ ^/(?=[^/]*[A-Z0-9])[A-Za-z0-9]{6}/.*$ {
        proxy_pass http://localhost:8123/api/static$uri$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 前端静态文件
    location / {
        root /var/www/aicodehub;
        try_files $uri $uri/ /index.html;
        index index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:8123/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 基本超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 600s;  # AI 生成可能需要较长时间
    }

    # SSE (Server-Sent Events) 流式传输支持
    location /api/app/generate/sse/ {
        proxy_pass http://localhost:8123/api/app/generate/sse/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 关键配置
        proxy_buffering off;
        proxy_cache off;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        chunked_transfer_encoding off;

        # 超长超时时间（AI 生成可能需要 10-20 分钟）
        proxy_connect_timeout 60s;
        proxy_send_timeout 1200s;
        proxy_read_timeout 1200s;
    }

    # Actuator 监控端点（可选，建议仅内网访问）
    location /api/actuator/ {
        # 仅允许内网访问（根据需要调整）
        # allow 192.168.0.0/16;
        # allow 10.0.0.0/8;
        # deny all;

        proxy_pass http://localhost:8123/api/actuator/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTPS 配置模板（使用 Let's Encrypt 证书后启用）
# server {
#     listen 443 ssl http2;
#     server_name yourname.com www.yourname.com;
#
#     ssl_certificate /etc/letsencrypt/live/yourname.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/yourname.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # 其余配置与上面相同
#     ...
# }

# HTTP 重定向到 HTTPS（启用HTTPS后取消注释）
# server {
#     listen 80;
#     server_name yourname.com www.yourname.com;
#     return 301 https://$server_name$request_uri;
# }
