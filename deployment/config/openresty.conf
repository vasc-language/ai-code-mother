# AICodeHub OpenResty 配置文件
# OpenResty 是基于 Nginx 的，配置语法完全兼容
# 位置: /usr/local/openresty/nginx/conf/vhost/aicodehub.conf
# 或: /etc/openresty/sites-available/aicodehub.conf

# Lua 共享字典（用于限流等）
lua_shared_dict limit_req_store 10m;

server {
    listen 80;
    server_name yourname.com www.yourname.com;  # 修改为你的域名

    # 访问日志
    access_log /var/log/openresty/aicodehub_access.log;
    error_log /var/log/openresty/aicodehub_error.log;

    # 客户端最大上传大小
    client_max_body_size 50M;

    # 前端静态文件
    location / {
        root /var/www/aicodehub;
        try_files $uri $uri/ /index.html;
        index index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API 限流（使用 Lua）
    location /api/ {
        # 限流：每个 IP 每秒最多 20 请求
        access_by_lua_block {
            local limit_req = require "resty.limit.req"
            local lim, err = limit_req.new("limit_req_store", 20, 10)
            if not lim then
                ngx.log(ngx.ERR, "failed to instantiate a resty.limit.req object: ", err)
                return ngx.exit(500)
            end

            local key = ngx.var.binary_remote_addr
            local delay, err = lim:incoming(key, true)
            if not delay then
                if err == "rejected" then
                    return ngx.exit(429)  -- Too Many Requests
                end
                ngx.log(ngx.ERR, "failed to limit req: ", err)
                return ngx.exit(500)
            end

            if delay >= 0.001 then
                ngx.sleep(delay)
            end
        }

        # 反向代理到后端
        proxy_pass http://localhost:8123/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 基本超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 600s;  # AI 生成可能需要较长时间
    }

    # SSE (Server-Sent Events) 流式传输支持
    location /api/app/generate/sse/ {
        proxy_pass http://localhost:8123/api/app/generate/sse/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 关键配置
        proxy_buffering off;
        proxy_cache off;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        chunked_transfer_encoding off;

        # 超长超时时间（AI 生成可能需要 10-20 分钟）
        proxy_connect_timeout 60s;
        proxy_send_timeout 1200s;
        proxy_read_timeout 1200s;
    }

    # Actuator 监控端点（仅内网访问）
    location /api/actuator/ {
        # 使用 Lua 检查 IP 白名单
        access_by_lua_block {
            local remote_addr = ngx.var.remote_addr
            local whitelist = {
                ["127.0.0.1"] = true,
                ["::1"] = true,
                -- 添加其他允许的 IP
                -- ["192.168.1.100"] = true,
            }

            if not whitelist[remote_addr] then
                ngx.exit(403)  -- Forbidden
            end
        }

        proxy_pass http://localhost:8123/api/actuator/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 健康检查端点（用于负载均衡）
    location /health {
        access_by_lua_block {
            ngx.say("OK")
            ngx.exit(200)
        }
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # WAF（Web Application Firewall）示例
    location ~* \.(php|jsp|asp|aspx|cgi)$ {
        return 403;  # 禁止访问这些文件
    }
}

# HTTPS 配置模板（使用 Let's Encrypt 证书后启用）
# server {
#     listen 443 ssl http2;
#     server_name yourname.com www.yourname.com;
#
#     ssl_certificate /etc/letsencrypt/live/yourname.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/yourname.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # SSL Session Cache
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#
#     # HSTS（强制 HTTPS）
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#
#     # 其余配置与上面相同
#     ...
# }

# HTTP 重定向到 HTTPS（启用HTTPS后取消注释）
# server {
#     listen 80;
#     server_name yourname.com www.yourname.com;
#     return 301 https://$server_name$request_uri;
# }
