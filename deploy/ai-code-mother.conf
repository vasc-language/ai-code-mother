# =============================================
# AI Code Mother OpenResty 配置文件
# 域名: https://your-domain.com
# 作者: Join2049
# 日期: 2025-10-04
# =============================================

# HTTP 服务器 - 重定向到 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;

    # 将所有 HTTP 请求重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS 主服务器
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL 证书配置（需要替换为实际证书路径）
    ssl_certificate /etc/ssl/certs/your-domain.com.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.com.key;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 日志配置
    access_log /var/log/openresty/ai-code-mother-access.log;
    error_log /var/log/openresty/ai-code-mother-error.log;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

    # 客户端请求体大小限制（用于文件上传）
    client_max_body_size 100M;

    # 根路径 - Vue 前端静态文件
    location / {
        root /var/www/ai-code-mother/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # API 反向代理 - 后端服务
    location /api/ {
        proxy_pass http://127.0.0.1:8123;
        proxy_http_version 1.1;

        # WebSocket 支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # SSE 支持（流式响应）
        proxy_buffering off;
        proxy_cache off;
    }

    # 部署的子应用静态文件服务
    location /dist/ {
        alias /var/www/ai-code-mother/deployments/;
        autoindex off;

        # 尝试查找文件，找不到返回 404
        try_files $uri $uri/ =404;

        # 静态资源缓存
        expires 7d;
        add_header Cache-Control "public";
    }

    # 用户注册页面（邀请链接路由）
    location /user/register {
        root /var/www/ai-code-mother/frontend;
        try_files /index.html =404;
    }

    # 用户登录页面
    location /user/login {
        root /var/www/ai-code-mother/frontend;
        try_files /index.html =404;
    }

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# =============================================
# 部署说明
# =============================================
# 1. 将此配置文件复制到 OpenResty 配置目录:
#    cp ai-code-mother.conf /usr/local/openresty/nginx/conf/vhost/
#
# 2. 修改主配置文件 nginx.conf，在 http 块中添加:
#    include /usr/local/openresty/nginx/conf/vhost/*.conf;
#
# 3. 替换 SSL 证书路径为实际证书
#
# 4. 创建必要的目录:
#    mkdir -p /var/www/ai-code-mother/frontend
#    mkdir -p /var/www/ai-code-mother/deployments
#    mkdir -p /var/log/openresty
#
# 5. 测试配置:
#    openresty -t
#
# 6. 重新加载配置:
#    openresty -s reload
#
# 或使用 systemctl:
#    systemctl reload openresty
# =============================================
